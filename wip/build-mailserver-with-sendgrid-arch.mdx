---
title: ArchLinuxにメールサーバー構築[バーチャルドメイン・ユーザー&LMTP] | xlog.systems
description: さくらのメールボックスから移行します。バーチャルドメイン・ユーザー&一部別メールボックス構成&LMTPでかなりゴテゴテしたサーバーを構築します。
date: 2024-10-30
tags: ['ArchLinux', 'メール', 'SendGrid']
categories: ['備忘録', '構築', 'メール']
keywords: ['postfix', 'dovecot', 'ArchLinux', 'メールサーバー', 'さくらのメールボックス', '移行', 'メール']
---

# 自宅サーバーでメールサーバーを構築する

## はじめに

自宅で結構長期間運用していた RedHat Enterprise Linux 9 サーバーが死に、 ArchLinux の強めのマシンに変わったため、メールサーバーをローカルに新規構築する計画を立てました。

というのも現在、特に理由なく自分が持っているドメインでメールを運用しています。

一年で数百円程度の費用でさくらのメールボックスを使っていました。
費用的にも最強だと思っていますが、メールのみ外部に依存しているのは、
メールだけ諦めたみたいな感じで嫌だったので、別に新しくメールサーバーを建てることにしました。

一つ先に忠告しておくと、かなりキモい設定を入れ込みました。インフラ屋なので、簡単な postfix サーバーの立ち上げだと味気なくて記事を書くモチベが上がらなかったので、バーチャルドメインしつつ一部のドメインはメールボックスを分けてあります。
正直保守性的にもあり得ない構成なのですが、こういうのができるのこそ自宅サーバーなので、あまり参考にされると地獄というか虚無になる可能性があります。

## 構築するサーバーについて

自宅で運用しているサーバーがあり、そいつの中に構築していきます。  
マイクラ運用もしている Intel の中古ゲーミングワークステーションの薄い版みたいなやつですね。Nuro の Onu 兼ルーターの直下から繋げてるので、回線だけ爆速です。
友人がマイクラサーバーを構築して公開したいってことだったので、そいつが多めに金払ってメルカリでいい型落ちゲーミングを狙ってこっちに発送されてきました。  
そいつと話し合った結果、インストールする OS は ArchLinux ということになりました。パッケージマネージャ(AUR ヘルパー)は paru を使ってます。

タイミングもいいので、ArchLinux にメールサーバーを構築していきます。Linux で建てるのとは、postfix,dovecot のインストールくらいまでは違う手順になりますが、ほぼ一緒だと思います。

また、一つ面倒なのが、ほとんどの家がそうだと思いますが、自宅回線なので、IP が動的というのと、OP25B の影響を受けます。
IP が動的というのは、Cloudflare API でサーバーのデーモンがうまいこと設定してくれます。しかし、OP25B は結構厄介です。
Outbound Port 25 Blocking の略ですが、読んで字の如く 25 ポートから出ていくトラフィックを ISP がブロックします。
だるいですが、実際ないと多分迷惑メールがやばいことになるので許します。まあ迷惑メールがなくなったわけじゃないんで、悪影響しか受けない自分は普通に最悪の気分です。今の時代騙される奴なんて中々いないだろうに。

### OP25B 回避策

OP25B 対策として、メール送信サービスを利用します。具体的には SendGrid を使います。postfix からリレー先として指定するだけだと思うので、本当に神です。
メールサーバーをローカル立ててるのにどういうこととは思いますが、確実に自宅の可用性よりクラウドのあっちの方が高いと思ってのことです笑

正直にいうと、OP25B の回避策がそれしかないためです。自宅回線は Nuro なのですが、契約時届いた Nuro のメールサーバー設定のハガキを今も画像で保持しているのですが、いざ使おうとしたところアカウントが削除されてました。使用していないアカウントは 2024 年の最初あたりで消されてたらしいです。普通にゴミです。

### メールボックス設定のキモい設定について

冒頭でも触れましたがユーザー・メールボックス周りがかなり気色悪い設定になっています。以下にやったことをまとめますが、作業ベースなので漏れがあるかもしれません。その時は連絡ください。直します。

現在運用中のさくらのメールボックスは、mydestination に複数ドメインを指定してあるだけみたいな環境です。例えば、mail@example.com,mail@example.netが宛先のメールは同じ mail のメールボックスに配送される、といった形です。  
そして、ユーザーはコンパネから作成する必要があります。
mail ユーザー以外もユーザーがあり、それら全てを Linux ユーザーとして作成するのは面倒だし/home/が汚れて普通に嫌です

これらとは別に、badcompany.tokyo というその ArchLinux を共同で管理している友人と所有しているドメインがあり、そのメールも捌きたいです。
しかし、このメールが個人仕様のドメインと同じメールボックスに配送されるのはかなり渋いです。したがって、badcompany.tokyo と自分の個人的なドメインは別メールボックスで管理します。

というか、全てのメールボックス設定値をテキスト形式の設定ファイルで完全に管理する形をとります。
かなり面倒ではありますが、テキストで管理するのは Linux のシステムユーザーを使った変な管理より安定していると感じるので、とりあえずその方向で頑張ってみます。  
NixFlake リスペクトです。まあ LMTP を使うので dovecot の設定をうまく管理できるように頑張るだけです。

- バーチャルユーザーを使用
- バーチャルドメインで複数のドメインを同一のメールボックスで管理
- 一部ドメインは別メールボックスで管理

以上の設定を一つの postfix 内で共存させます。

### メールサーバー設定まとめ

主なプログラム

- postfix
- dovecot
- SendGrid

今回のサーバーについては、セキュリティ的に弱いポートなどは基本的に外出ししない方針で行きます。
受信のために 25 ポートを開ける必要はありますが。

また、POP3 は使用しません。

SMTP : 25,587
IMAP : 993

共に STARTTLS 使用予定  
証明書は LetsEncrypt のものを使用。

SASL 認証サーバーは、Dovecot を使用します。  
送受信の認証を一本化できるからです。そのため Cyrus SASL は使用しません。

自宅のサーバーが落ちた場合、メールが配達不可になってしまうため、念の為フェイルオーバーとして、さくらのメールボックスは契約し続けます。(?)

メールサーバーの具体的な設定値は以下のとおりです。コマンドを参照する際に参考になれば。

バーチャルユーザーのメール保存場所 : `/var/mail/vhosts/DOMAIN/USERNAME`
バーチャルユーザーのメール保存形式 : `Maildir`
バーチャルユーザーのパスワード保存形式 : `SHA512-CRYPT` ※1

※1 意味なく少しセキュアにしています。

## 作業

### 1. プログラム類インストール

postfix,dovecot をインストールします。

```
[buntin@badcompany ~]$ paru -S postfix dovecot
resolving dependencies...
looking for conflicting packages...
warning: dependency cycle detected:
warning: postfix-lmdb will be installed before its postfix dependency

Packages (6) liburing-2.8-1  mariadb-libs-11.6.2-2  postfix-lmdb-3.9.0-4  postgresql-libs-16.3-4  dovecot-2.3.21.1-1  postfix-3.9.0-4

Total Download Size:   12.06 MiB
Total Installed Size:  47.35 MiB

:: Proceed with installation? [Y/n]
:: Retrieving packages...
 mariadb-libs-11.6.2-2-x86_64                                                                                   5.4 MiB  17.2 MiB/s 00:00 [####################################################################################] 100%
 dovecot-2.3.21.1-1-x86_64                                                                                      3.5 MiB  57.8 MiB/s 00:00 [####################################################################################] 100%
 postgresql-libs-16.3-4-x86_64                                                                               1673.7 KiB  40.9 MiB/s 00:00 [####################################################################################] 100%
 postfix-3.9.0-4-x86_64                                                                                      1371.4 KiB  33.5 MiB/s 00:00 [####################################################################################] 100%
 liburing-2.8-1-x86_64                                                                                        189.4 KiB  6.85 MiB/s 00:00 [####################################################################################] 100%
 postfix-lmdb-3.9.0-4-x86_64                                                                                   21.6 KiB   830 KiB/s 00:00 [####################################################################################] 100%
 Total (6/6)                                                                                                   12.1 MiB  18.0 MiB/s 00:01 [####################################################################################] 100%
(6/6) checking keys in keyring                                                                                                            [####################################################################################] 100%
(6/6) checking package integrity                                                                                                          [####################################################################################] 100%
(6/6) loading package files                                                                                                               [####################################################################################] 100%
(6/6) checking for file conflicts                                                                                                         [####################################################################################] 100%
(6/6) checking available disk space                                                                                                       [####################################################################################] 100%
:: Processing package changes...
(1/6) installing postfix-lmdb                                                                                                             [####################################################################################] 100%
(2/6) installing postfix                                                                                                                  [####################################################################################] 100%
Optional dependencies for postfix
    perl: for postfix-collate.pl, postfix-tlstype.pl and qshape [installed]
    postfix-cdb: for CDB integration
    postfix-ldap: for LDAP integration
    postfix-lmdb: for LMDB integration [installed]
    postfix-mongodb: for MongoDB integration
    postfix-mysql: for MySQL integration
    postfix-pcre: for PCRE integration
    postfix-pgsql: for PostgreSQL integration
    postfix-sqlite: for SQLite integration
(3/6) installing liburing                                                                                                                 [####################################################################################] 100%
(4/6) installing mariadb-libs                                                                                                             [####################################################################################] 100%
Optional dependencies for mariadb-libs
    krb5: for gssapi authentication [installed]
(5/6) installing postgresql-libs                                                                                                          [####################################################################################] 100%
(6/6) installing dovecot                                                                                                                  [####################################################################################] 100%
Optional dependencies for dovecot
    libldap: ldap plugin [installed]
    lua53: LUA auth and push support
    clucene: alternative FTS indexer
:: Running post-transaction hooks...
(1/4) Creating system user accounts...
Creating group 'postdrop' with GID 75.
Creating group 'dovenull' with GID 74.
Creating user 'dovenull' (Dovecot user for completely untrustworthy processes) with UID 74 and GID 74.
Creating group 'dovecot' with GID 76.
Creating user 'dovecot' (Dovecot user) with UID 76 and GID 76.
Creating group 'postfix' with GID 73.
Creating user 'postfix' (n/a) with UID 73 and GID 73.
(2/4) Reloading system manager configuration...
(3/4) Creating temporary files...
(4/4) Arming ConditionNeedsUpdate...
```

### 2. dovecot の設定

#### 2.1 /etc/dovecot の確認

LMTP を使用する関係上、dovecot から設定しました。どちらが先でも良いかと思います。

ArchLinux なので、 `/etc/dovecot` が自動生成されません。  
テンプレからコピーします。

```
root@badcompany /etc/dovecot                                                        [0:31:20]
> # cp /usr/share/doc/dovecot/example-config/dovecot.conf /etc/dovecot
root@badcompany /etc/dovecot                                                        [0:31:32]
> # cp -r /usr/share/doc/dovecot/example-config/conf.d /etc/dovecot
root@badcompany /etc/dovecot                                                        [0:31:38]
> # ls -l
total 12
drwxr-xr-x 2 root root 4096 Dec  6 00:31 conf.d
-rw-r--r-- 1 root root 4333 Dec  6 00:31 dovecot.conf
root@badcompany /etc/dovecot                                                        [0:47:45]
> # ls -l conf.d
total 128
-rw-r--r-- 1 root root  5248 Dec  6 00:31 10-auth.conf
-rw-r--r-- 1 root root  1781 Dec  6 00:31 10-director.conf
-rw-r--r-- 1 root root  3757 Dec  6 00:31 10-logging.conf
-rw-r--r-- 1 root root 17770 Dec  6 00:31 10-mail.conf
-rw-r--r-- 1 root root  3619 Dec  6 00:31 10-master.conf
-rw-r--r-- 1 root root  1585 Dec  6 00:31 10-metrics.conf
-rw-r--r-- 1 root root  3433 Dec  6 00:31 10-ssl.conf
-rw-r--r-- 1 root root  1657 Dec  6 00:31 15-lda.conf
-rw-r--r-- 1 root root  3111 Dec  6 00:31 15-mailboxes.conf
-rw-r--r-- 1 root root  4520 Dec  6 00:31 20-imap.conf
-rw-r--r-- 1 root root  1367 Dec  6 00:31 20-lmtp.conf
-rw-r--r-- 1 root root  4066 Dec  6 00:31 20-pop3.conf
-rw-r--r-- 1 root root  4299 Dec  6 00:31 20-submission.conf
-rw-r--r-- 1 root root   676 Dec  6 00:31 90-acl.conf
-rw-r--r-- 1 root root   292 Dec  6 00:31 90-plugin.conf
-rw-r--r-- 1 root root  2596 Dec  6 00:31 90-quota.conf
-rw-r--r-- 1 root root   499 Dec  6 00:31 auth-checkpassword.conf.ext
-rw-r--r-- 1 root root   489 Dec  6 00:31 auth-deny.conf.ext
-rw-r--r-- 1 root root   343 Dec  6 00:31 auth-dict.conf.ext
-rw-r--r-- 1 root root   924 Dec  6 00:31 auth-ldap.conf.ext
-rw-r--r-- 1 root root   561 Dec  6 00:31 auth-master.conf.ext
-rw-r--r-- 1 root root   515 Dec  6 00:31 auth-passwdfile.conf.ext
-rw-r--r-- 1 root root   788 Dec  6 00:31 auth-sql.conf.ext
-rw-r--r-- 1 root root   611 Dec  6 00:31 auth-static.conf.ext
-rw-r--r-- 1 root root  2182 Dec  6 00:31 auth-system.conf.ext
```

conf.d で、ファイルによるバーチャルユーザー管理を有効にします。  
root と buntin ユーザーでプロンプトが違うのは共用のためです。

```
root@badcompany /etc/dovecot/conf.d                                                 [1:15:22]
> # cp -p 10-auth.conf{,.$(date "+%Y%m%d")}
root@badcompany /etc/dovecot/conf.d                                                 [1:17:06]
> # vim 10-auth.conf
root@badcompany /etc/dovecot/conf.d                                                 [1:25:05]
> # diff 10-auth.conf.20241206 10-auth.conf
10c10
< #disable_plaintext_auth = yes
---
> disable_plaintext_auth = yes
100c100
< auth_mechanisms = plain
---
> auth_mechanisms = plain login
125c125
< #!include auth-passwdfile.conf.ext
---
> !include auth-passwdfile.conf.ext
```

#### 2.2 dovecot の仮想ユーザー設定

### ?. SendGrid 整備
