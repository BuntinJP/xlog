---
title: ArchLinuxでsyslog-ngのログローテートをlogrotateで設定する方法
description: test post
date: 2023-02-10
tags: ['Zero Trust','Cloudflare']
categories: ['備忘録', 'サーバー','ミドルウェア']
draft : true
---
# ArchLinuxでsyslog-ngのログローテートをlogrotateで設定する方法

ArchLinuxのsyslog-ngにて出力している`/var/log/mail.log`をログローテートして圧縮か削除するスクリプトを作成したくなったので、一旦ログローテートの設定を整備します。

ArchLinuxでsyslog-ngのログローテートをlogrotateで設定する方法

ArchLinuxのPackageに`logrotate`というまんまのやつがあります。  
そいつでセットアップします。

```
root@badcompany ~                                               [0:41:12]
> # paru -S logrotate                                                    
resolving dependencies...
looking for conflicting packages...

Packages (1) logrotate-3.22.0-1

Total Installed Size:  0.10 MiB

:: Proceed with installation? [Y/n] 
(1/1) checking keys in keyring                     [################] 100%
(1/1) checking package integrity                   [################] 100%
(1/1) loading package files                        [################] 100%
(1/1) checking for file conflicts                  [################] 100%
(1/1) checking available disk space                [################] 100%
:: Processing package changes...
(1/1) installing logrotate                         [################] 100%
:: Running post-transaction hooks...
(1/2) Reloading system manager configuration...
(2/2) Arming ConditionNeedsUpdate...
                                                                          
root@badcompany ~                                               [0:41:30]
> # sudo systemctl status logrotate                                      
○ logrotate.service - Rotate log files
     Loaded: loaded (/usr/lib/systemd/system/logrotate.service; static)
     Active: inactive (dead)
TriggeredBy: ○ logrotate.timer
       Docs: man:logrotate(8)
             man:logrotate.conf(5)
                                                                          
root@badcompany ~                                               [0:42:01]
> # cat /etc/logrotate.conf                                              
# see "man logrotate" for details
# rotate log files weekly
weekly

# keep 4 weeks worth of backlogs
rotate 4

# restrict maximum size of log files
#size 20M

# create new (empty) log files after rotating old ones
create

# uncomment this if you want your log files compressed
#compress

# Logs are moved into directory for rotation
# olddir /var/log/archive

# Ignore pacman saved files
tabooext + .pacorig .pacnew .pacsave

# Arch packages drop log rotation information into this directory
include /etc/logrotate.d

/var/log/wtmp {
    monthly
    create 0664 root utmp
    minsize 1M
    rotate 1
}

/var/log/btmp {
    missingok
    monthly
    create 0600 root utmp
    rotate 1
}
                                                                          
root@badcompany ~                                               [0:42:40]
> # cd /etc/logrotate.d                                                  
root@badcompany /etc/logrotate.d                                [0:44:46]
> # cp -p /etc/logrotate.conf{,.$(date "+%Y%m%d")}                       
root@badcompany /etc/logrotate.d                                [0:43:50]
> # nvim /etc/logrotate.conf                                             
```

各種ライブラリの導入段階で、それぞれ必要なファイルが生成されています。

今回の場合、syslog-ngのもののため、`/etc/logrotate.d/syslog-ng`というファイルを探します。

```
root@badcompany /etc/logrotate.d                [15:22:05]
> # cat syslog-ng                                         
/var/log/messages.log /var/log/auth.log /var/log/mail.log /var/log/kernel.log /var/log/errors.log /var/log/daemon.log /var/log/user.log /var/log/iptables.log /var/log/everything.log /var/log/syslog.log /var/log/acpid.log /var/log/crond.log /var/log/lpr.log /var/log/uucp.log /var/log/news.log /var/log/ppp.log /var/log/debug.log {
        missingok
        sharedscripts
        postrotate
                /bin/kill -HUP $(cat /run/syslog-ng.pid 2>/dev/null) 2>/dev/null || true
        endscript
}
```

これらにより、logrotateに対する設定が自動的に行われています。
設定内容は、sharedscriptsを使ってまとめて終わった後にsyslog-ngをリスタートしたり色々しています。正直言って自分は全く使いこなせていませんが、複雑な機構などもプロの方などは使いこなしているのでしょう。 `man logrotate` などで詳しく内容を読めますので、興味がある方は見てみると面白いかもですね。

以下、余談です。

Nginxのログ用に以下のようなやつも設定してみました。

```
> # cat nginx                                             
/var/log/nginx/*log {
        missingok
        notifempty
        create 640 http root
        sharedscripts
        compress
        postrotate
                test ! -r /run/nginx.pid || kill -USR1 `cat /run/nginx.pid`
        endscript
}
```

と言っても、ほとんどテンプレの丸写しです。
今までほぼローカルはのアクセスと思われていた接続についてはログを入れていなかったのですが、念の為撮るようにしました。

tailscale経由のみでしかアクセスできないようにすることも検討したんですが、流石に不便すぎるし、そのうち出ると噂のiOS版Thunderbirdに待機するためにも、例に漏れずキショ構造となっていますが、誰かの琴線に触れれば幸いです。

では。

