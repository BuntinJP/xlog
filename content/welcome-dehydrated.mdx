---
title: 'Cloudflareã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç®¡ç†ã™ã‚‹ãƒ–ãƒ­ã‚°ã®SSLè¨¼æ˜æ›¸ã‚’ã‚ˆã‚Šå¼·å›ºã«è‡ªå‹•æ›´æ–°ã—ãŸã„[dehydrated]'
description: SSL è¨¼æ˜æ›¸ã‚’ certbot ã§ cron ã™ã‚‹ã ã‘ã®ãƒãƒ³ ğŸ™† ã‚¹è„³æ­»æ§‹æˆã§ã¯ãªãã€ã¡ã‚ƒã‚“ã¨ CloudflareAPI ã‚’åˆ©ç”¨ã—ãŸå …ç‰¢ãªè¨¼æ˜æ›¸è‡ªå‹•æ›´æ–°ç’°å¢ƒã‚’ä½œæˆã—ãŸã„ã€‚
date: 2024-03-08
categories: ['å·¥ä½œ','Linux','SSL']
tags: ['dehydrated','Cloudflare']
keywords: ['dehydrated', "Let's Encrypt", 'certbot', 'SSL', 'Cloudflare', 'è¨¼æ˜æ›¸', 'æ›´æ–°', 'ã‚¹ã‚¯ãƒªãƒ—ãƒˆ']
---

## ã‚ˆã‚Šå¼·å›ºã«ï¼Ÿï¼Ÿ

ãªã‚“ã¦è¨€ã£ãŸï¼Ÿ

**SSL è¨¼æ˜æ›¸ã‚’ certbot ã§ cron ã™ã‚‹ã ã‘ã®ãƒãƒ³ ğŸ™† ã‚¹è„³æ­»æ§‹æˆã§ã¯ãªãã€ã¡ã‚ƒã‚“ã¨ CloudflareAPI ã‚’åˆ©ç”¨ã—ãŸå …ç‰¢ãªè¨¼æ˜æ›¸è‡ªå‹•æ›´æ–°ç’°å¢ƒã‚’ä½œæˆã—ãŸã„ã€‚**

ä½•ã“ã„ã¤ï¼Ÿã£ã¦æ„Ÿã˜ã§ã—ã‚‡ã†ã‹ã€‚

ã€Œè„³æ­»æ§‹æˆã€ã¨ã¯ã€ã‚µãƒ¼ãƒãƒ¼ä¸Šã§ä¸€æ™‚çš„ã« http ã‚’é–‹ã‘ã¦ `certbot -d example.com ...` ã¿ãŸã„ãªã‚³ãƒãƒ³ãƒ‰ã‚’ã€ãã®ã¾ã¾ cron ã«å…¥ã‚Œã‚‹ã¨ã‹ã§ã™ã€‚  
ã‚ˆãè¡Œã‚ã‚Œã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚ç¢ºã‹ã«æ¥½ã ã¨ã¯æ€ã„ã¾ã™ã€‚

ã—ã‹ã—ã€è‡ªåˆ†ã¯ã€ã§ãã‚‹ã ã‘å˜ç´”ã§æ©Ÿæ¢°çš„ã«å‹•ãã‚¹ã‚¿ãƒƒã‚¯ã®æ–¹ãŒå¥½ãã§ã™ã€‚c

ä»Šå›ã¯ãã‚“ãªè‡ªåˆ†ãŒç´å¾—ã§ããŸè§£æ±ºç­–ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## ç’°å¢ƒ

è¨¼æ˜æ›¸ã‚’å–å¾—ã™ã‚‹ç’°å¢ƒã‚’ç´¹ä»‹ã—ã¦ãŠãã¾ã™ã€‚

ISP: Nuro å…‰ (So-net)  
OS: ArchLinux

ZTE è£½ã® Nuro ã® ONU ã§ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¡Œã„ã€å®£è¨€çš„ã«ãƒãƒ¼ãƒˆã‚’è§£æ”¾ã—ã¦ã„ã¾ã™ã€‚

ä½¿ç”¨ç”¨é€”ã¯ä¸»ã«ã€è¶£å‘³ã§ã®é–‹ç™ºã¨ãªã‚Šã¾ã™ã€‚
ã‚²ãƒ¼ãƒ ç”¨ã®ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ãŸã‚Šã‚‚ã—ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€Cloudflareã§å–å¾—ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å‘ã‘ã¦ã„ã¾ã™ã€‚

ã¾ãšã€è‡ªå®…å›ç·šã§ãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ©ãƒ³ã§ã‚‚ãªã„ã®ã§ ISP ã‹ã‚‰æ‰•ã„å‡ºã•ã‚ŒãŸ IP ãŒå¤‰ã‚ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
Nuro ã‚’å°å…¥ã—ã¦æ—© 7 å¹´ã»ã©çµŒã¡ã¾ã™ãŒã€ä»Šã®æ‰€1åº¦ã—ã‹å¤‰åŒ–ã—ã¦ã„ã¾ã›ã‚“ã€‚

ã—ã‹ã—ã€ãã‚Œã§ã‚‚ã‚„ã¯ã‚Šãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ IP ãŒæ©Ÿæ¢°çš„ã«ã¤ãªãŒã£ã¦ã„ãªã„ã¨å®‰å¿ƒã§ããªã„ç§ã¯ã€Cloudflare API ã‚’åˆ©ç”¨ã—ãŸãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ DNS ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

ãã†ã§ã™ã€‚Cloudflare API ã‚’ç¾æ™‚ç‚¹ã§åˆ©ç”¨ã—ã¦ã„ã‚‹ã®ã§ã™ã€‚

## ä»Šã¾ã§ã®è¨¼æ˜æ›¸æ›´æ–°

ã¾ãšå¤§å‰æã¨ã—ã¦ã€è¶£å‘³ç”¨ã‚µãƒ¼ãƒãƒ¼ã§ã™ã®ã§ã€æœ‰å„Ÿè¨¼æ˜æ›¸ã¯è«–å¤–ã§ã™ã€‚ã¨ã„ã†ã‹ã€æœ‰å„Ÿè¨¼æ˜æ›¸ã¯ã‚¨ãƒ³ãƒ—ãƒ©ã«å£²ã‚‹å•†å“ã§ã—ã‹ãªã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚·ãƒ³ãƒœãƒ«ãƒ“ã‚¸ãƒã‚¹ã§ã™ã€‚

ä»Šã¾ã§ã¯ã€è¤‡æ•°ã®ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¯¾ã—ã¦ã€certbot ã§è¨¼æ˜æ›¸ã‚’ã‚µãƒ¼ãƒãƒ¼å†…ã‹ã‚‰å–å¾—ã™ã‚‹ã‚‚ã®ã¨ã€ZeroSSL ã‚’åˆ©ç”¨ã™ã‚‹ 2 ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ··åœ¨ã—ã¦ã„ã¾ã—ãŸã€‚

> [certbot](https://certbot.eff.org/) - Let's Encrypt ã®å…¬å¼ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

> [ZeroSSL](https://zerossl.com/) - [ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç„¡æ–™ã§ç°¡å˜ã«è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã§ãã‚‹ ZeroSSL | DevelopersIO](https://dev.classmethod.jp/articles/zerossl-a-free-and-easy-way-to-issue-certificates-from-your-browser/)

ãƒ‰ãƒ¡ã‚¤ãƒ³ã”ã¨ã«ã€ä½•ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã®ã‹ã‚ã‹ã‚Šã«ããã€ã‹ã¤ ZeroSSL ã«ã¤ã„ã¦ã¯è¨¼æ˜æ›¸ã®æ›´æ–°æ™‚ã®èª²é‡‘ã®å¼·åˆ¶æ„Ÿ(ã†ã¾ãã‚„ã‚Œã°(æœ¬æ¥ã¯)æ‰•ã‚ãªãã¦è‰¯ã„)ãŒã†ã–ã‹ã£ãŸã®ã§ã€ã‚„ã‚ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰æ‰‹é ƒã«ã¨ã£ã¦æ¥ã‚Œã‚‹ã®ã¯è‰¯ã„ã‚“ã§ã™ã‘ã©ã­ã€‚

**ã§ï¼Ÿ**

çµå±€ã“ã„ã¤ã‚‰ãŒã‚„ã£ã¦ã‚‹ã®ã¯ ACME ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«æº–ã˜ãŸè‡ªå‹•çš„ãªè¨¼æ˜æ›¸ã®ç™ºè¡Œã§ã™ã€‚å‰ã„ã®ã¯ CA ã§ã‚ã£ã¦ã“ã„ã¤ã‚‰ã§ã¯æ±ºã—ã¦ã‚ã‚Šã¾ã›ã‚“ã€‚ã„ã‚„ ZeroSSL ã¯ãƒ¯ãƒ³ãƒãƒ£ãƒ³å‰ã„ã‹ï¼Ÿ

ã¾ãŸã€certbot ã¯ç›®çš„ã«å¯¾ã—ã¦ä¸å¿…è¦ã«ã§å¤šæ©Ÿèƒ½ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã™ã€‚web ã‚µãƒ¼ãƒãƒ¼æ©Ÿèƒ½ã¾ã§æŒã£ã¡ã‚ƒã£ã¦ã¾ã™ã€‚

è‡ªåˆ†ã¯ã‚ã¾ã‚Šå¥½ã¿ã§ã¯ãªã„ã§ã™ã€‚è‡ªå®…ã«çŸ¥ã‚‰ãªã„æ¥­è€…ãŒå®šæœŸçš„ã«ä¸ŠãŒã‚Šè¾¼ã‚“ã§ãã¦å‹æ‰‹ã«ã‚±ãƒ¼ãƒ–ãƒªãƒ³ã‚°ã—ã¦ã„ãã¿ãŸã„ãªå±…å¿ƒåœ°ã®æ‚ªã•ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸ŠãŒç¾çŠ¶ã¾ã¨ã‚ã€ã¨ãªã‚Šã¾ã™ã€‚

## ä»Šå¾Œã®è¨¼æ˜æ›¸æ›´æ–°

æ•´ç†ã™ã‚‹ã¨ã€è¦ä»¶ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

- ç„¡æ–™ã§åˆ©ç”¨ã§ãã‚‹ã“ã¨(Let'sEncrypt)
- dns-01ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’åˆ©ç”¨ã—ãŸã„
- certbot ã¯å°‘ã—å¤šæ©Ÿèƒ½ã™ãã‚‹ã€‚ZeroSSL ã¯è«–å¤–

ä»¥ä¸Šã®è¦ä»¶ã‹ã‚‰ã€è‡ªåˆ†ãŒå‡ºã—ãŸç­”ãˆã¯ä»¥ä¸‹2ã¤ã®æ§‹æˆã§ã™ã€‚

**dehydrated**

[github](https://github.com/dehydrated-io/dehydrated) - ã‚·ã‚§ãƒ«ã§æ›¸ã‹ã‚ŒãŸ acme ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (å¿…è¦ãªæ©Ÿèƒ½ã¯å…¨ã¦ã‚ã‚Šã¤ã¤éå¸¸ã«å˜ç´”æ˜å¿«ãªæ§‹é€ ã‚’ã—ã¦ã„ã¾ã™)

**letsencrypt-cloudflare-hook**

[github](https://github.com/kappataumu/letsencrypt-cloudflare-hook) - python è£½ hooks ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (dehydrated ãŒãƒãƒ£ãƒ¬ãƒ³ã‚¸ã® TXT ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ CloudflareAPI çµŒç”±ã§è¨­å®šã§ãã¾ã™ã€‚)

ãƒ¬ã‚´ã§è‡ªåˆ†ãŒæ¬²ã—ã„ã¨ã“ã‚ã ã‘çµ„ã‚“ã ã‚ˆã†ãªæ„Ÿã˜ã§ã™ã­ã€‚è‡ªåˆ†ã¨ã—ã¦ã¯ã“ã‚Œã‚‰ã‚’è¦‹ã¤ã‘ãŸã¨ãçµæ§‹æœ¬æ°—ã§é‹å‘½æ„Ÿã˜ã¾ã—ãŸã€‚

### dehydrated ã¨ã¯

*dehydrated*ã¯ certbot ã¨åŒã˜ã ACME ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«å¯¾å¿œã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã™ã€‚å˜ä¸€ã®bashã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚ã“ã®ä¸Šãªãã‚·ãƒ³ãƒ—ãƒ«ã§ã‚‚ã¯ã‚„ç¾ã—ã„ã§ã™ã€‚

certbot ã¨é•ã„ã€è¨¼æ˜æ›¸ã®å–å¾—ã®ã¿ã‚’è¡Œã„ã¾ã™ã€‚è¨¼æ˜æ›¸ã®è¨­å®šãªã©ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã§è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã—ã‹ã—ã€ã‚„ã‚‹ã“ã¨ã¯è¨¼æ˜æ›¸ã®æ›´æ–°ãªã®ã§ã€è¨­å®šã¯ã™ã§ã«çµ‚ã‚ã£ã¦ã„ã‚‹ã¯ãšã§ã™ã‚ˆã­ã€‚ãªã®ã§æ­£ç›´è¨¼æ˜æ›¸ã®æ›´æ–°ã”ã¨ãã§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã„ã˜ã‚‹ã ã®ãªã‚“ã ã®ã£ã¦è©±ã‹ã‚‰ãŠã‹ã—ã„ã‚“ã§ã™ã‚ˆã€‚  

certbotã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‹æ‰‹ã«ç·¨é›†ã™ã‚‹æ©Ÿèƒ½ã¯ãƒã‚¸ã§ãªã‚“ã®ãŸã‚ã«ã‚ã‚‹ã‚“ã§ã™ã‹ï¼Ÿé‚ªé­”ã«ã—ã‹æ„Ÿã˜ã¾ã›ã‚“ã€‚

**dehydrated ã«ã¯ãã‚“ãªä½™è¨ˆã™ãã‚‹æ©Ÿèƒ½ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚**

æœ¬å½“ã«ã„ã‚‰ãªã„ã§ã™ã€‚ãã†ã„ã†æ©Ÿèƒ½ã¯ã€‚

å«Œãªã‚‰ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹ãªã‚ˆã¨ã„ã†åè«–ã¯æ‰¿çŸ¥ã—ã¦ã„ã¾ã™ã€‚  
ãŒã€è‡ªåˆ†ã¯è¶£å‘³ã‚µãƒ¼ãƒãƒ¼ã§é‡ã„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ›ã‚¹ãƒˆã—ã¦ã‚‹ã‚ã‘ã§ã‚‚ãªã„ã®ã§ã€é »ç¹ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å…¨æ›´æ–°ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

ãã®ç’°å¢ƒãªã®ã‚‚ã‚ã‚Šã€ã‚„ã£ã±ã‚Šä½™è¨ˆãªæ©Ÿèƒ½ãŒãªã„ã‚·ãƒ³ãƒ—ãƒ«ãªã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¥½ããªã®ã§ã™ã€‚dehydrated ã¯ã¾ã•ã«ãã‚Œã‚’ä½“ç¾ã™ã‚‹ç¥ãƒ„ãƒ¼ãƒ«ã¨ã„ã†ã“ã¨ã§ã™ã€‚

### letsencrypt-cloudflare-hook ã¨ã¯

çµæ§‹å¤ã„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚ã—ã‹ã—ã€æ©Ÿèƒ½ã¯ååˆ†ã§ã™ã€‚

*letsencrypt-cloudflare-hook*ã¯ã€dehydrated ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³çš„ãªã‚‚ã®ã§ã™ã€‚ãƒ¬ãƒã‚¸ãƒˆãƒªåã« dehydrated ãŒå«ã¾ã‚Œã¦ã„ãªã„ã®ã§åˆ†ã‹ã‚Šã¥ã‚‰ã„ã§ã™ãŒã€‚ä»–ã®ACMEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚‚åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ãªã®ã§ã“ã®åå‰ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

dehydrated ã¯ã€hooks ã¨ã„ã†å½¢ã§ API ã®ã‚ˆã†ãªã‚‚ã®ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚dehydratedãŒè¨¼æ˜æ›¸å–å¾—ã®ãŸã‚ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸æƒ…å ±ã‚’å—ã‘ã¨ã‚Šã€ãã‚Œã‚’ä½•ã‚‰ã‹ã®å½¢ã§åˆ©ç”¨ã—ã¦ã„ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã®APIçµŒç”±ã§ç™»éŒ²ã—ãŸã‚Šã™ã‚‹ãŸã‚ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¨ã„ã†ä½ç½®ã¥ã‘ã§ã™ã€‚

ãã—ã¦ã€åå‰ã®é€šã‚Šã€letsencrypt-cloudflare-hookã¯CloudflareAPIã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹ãŸã‚ã®hooksã§ã™ã€‚

APIã‚­ãƒ¼ã®ç™»éŒ²ã®ã¿ã§ã€dehydrated ãŒãƒãƒ£ãƒ¬ãƒ³ã‚¸æƒ…å ±ã‚’ CloudflareAPI çµŒç”±ã§ç™»éŒ²ã€å‰Šé™¤ã—ã¦ãã‚Œã¾ã™ã€‚

Cloudflareã§ã¯ãƒ¡ãƒ¼ãƒ«ã¨APIã‚­ãƒ¼ã®çµ„ã¿åˆã‚ã›ã¯éæ¨å¥¨ã¨ãªã£ã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€æ–°ã—ã„APIãƒˆãƒ¼ã‚¯ãƒ³æ–¹å¼ã ã¨ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã”ã¨ã«APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æƒ…å ±ã¨ã—ã¦ã‚¾ãƒ¼ãƒ³ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æœ¬å½“ã¯è‡ªå‹•å–å¾—å¯èƒ½ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã™ãŒã€èª¿ã¹ãŸé™ã‚Šè‡ªå‹•å–å¾—ã¾ã§è¡Œã£ã¦ãã‚Œã‚‹hookã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

dehydratedã«å–å¾—å¯¾è±¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŒ‡å®šã™ã‚‹`domains.txt`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã§ã™ãŒã€ãã“ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§è¨¼æ˜æ›¸ç™ºè¡Œã‚’æœ‰åŠ¹ã«ã—ãŸã‹ã£ãŸã®ã§ã€ä»Šå›ã¯éæ¨å¥¨ãªãŒã‚‰APIã‚­ãƒ¼æ–¹å¼ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

## è¨­å®šå†…å®¹

ã“ã‚Œã‚’è¦‹ã«æ¥ã¦ã„ã‚‹æ–¹ã«ã¯ä½¿ã„æ–¹ãŒã‚ã‹ã£ã¦ã„ã‚‹ãƒ„ãƒ¼ãƒ«ã®èª¬æ˜ãªã©ã„ã‚‰ãªã„ã‹ã¨æ€ã„ã¾ã™ãŒã€ç§ãŒè¨­å®šã—ãŸå†…å®¹ã‚’è§£èª¬ã—ã¦ãŠãã¾ã™ã€‚

å…¬å¼æƒ…å ±ã¯[ã“ã¡ã‚‰](https://github.com/dehydrated-io/dehydrated)ã‚’ã©ã†ãã€‚

1. dehydrated ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

`/opt/dehydrated`ã«è¨­ç½®ã—ã¾ã—ãŸ

```
># git clone git@github.com:dehydrated-io/dehydrated.git /opt/dehydrated                    
---
Cloning into '/opt/dehydrated'...
remote: Enumerating objects: 2485, done.
remote: Counting objects: 100% (162/162), done.
remote: Compressing objects: 100% (41/41), done.
remote: Total 2485 (delta 147), reused 122 (delta 121), pack-reused 2323 (from 3)
Receiving objects: 100% (2485/2485), 938.95 KiB | 1.94 MiB/s, done.
Resolving deltas: 100% (1561/1561), done.
```

2. letsencrypt-cloudflare-hook ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

[å…¬å¼](https://github.com/kappataumu/letsencrypt-cloudflare-hook)ã®ã‚µãƒ³ãƒ—ãƒ«é€šã‚Šã€`hooks/cloudflare`ã«è¨­ç½®ã—ã¾ã—ãŸ

```
># cd /opt/dehydrated/
># git clone git@github.com:kappataumu/letsencrypt-cloudflare-hook.git hooks/cloudflare
---
Cloning into 'hooks/cloudflare'...
remote: Enumerating objects: 158, done.
remote: Counting objects: 100% (67/67), done.
remote: Compressing objects: 100% (13/13), done.
remote: Total 158 (delta 60), reused 54 (delta 54), pack-reused 91 (from 1)
Receiving objects: 100% (158/158), 32.00 KiB | 4.00 MiB/s, done.
Resolving deltas: 100% (83/83), done.
```

3. Cloudflareã‹ã‚‰APIã‚­ãƒ¼ã‚’å–å¾—

Cloudflareã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰å–å¾—å¯èƒ½ã§ã™

[Get Global API key (legacy) Â· Cloudflare Fundamentals docs](https://developers.cloudflare.com/fundamentals/api/get-started/keys/)

4. dehydrated ã®åˆæœŸåŒ–ãƒ»è¨­å®š

æœ€åˆã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã®ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚

```
># cd /opt/dehydrated
># ./dehydrated --register --accept-terms
---
#
# !! WARNING !! No main config file found, using default config!
#
+ Generating account key...
+ Registering account key with ACME server...
+ Fetching account URL...
+ Done!
```

dehydratedã®configã«Cloudflareã®APIã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãŠãã¾ã™

```
># cd /opt/dehydrated
># cp docs/examples/config config
># echo "export CF_EMAIL=EMAIL_HERE" >> config
># echo "export CF_KEY=API_KEY_HERE" >> config
```

5. å¯¾è±¡ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®š

`/opt/dehydrated/domains.txt`ã«å–å¾—ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚  
1è¡ŒãŒ1æšã®è¨¼æ˜æ›¸ã«å¯¾å¿œã—ã¦ãŠã‚Šã€ãƒãƒ«ãƒãƒ‰ãƒ¡ã‚¤ãƒ³(ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å«ã‚)å¯¾å¿œã®è¨¼æ˜æ›¸ã¯1è¡Œã«ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§è¨˜è¿°ã™ã‚‹ã“ã¨ã§å¯¾å¿œå¯èƒ½ã§ã™ã€‚

```text title="domains.txt"
code.example.com
ubcode.example.com
example.com
```

## çµæœ

`./dehydrated -c -t dns-01 -k 'hooks/cloudflare/hook.py'`ã“ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã§è¨¼æ˜æ›¸ã‚’å–å¾—ã§ãã¾ã™ã€‚

```
[::] buntin@example.com:/opt/dehydrated (master %) $ ./dehydrated -c -t dns-01 -k 'hooks/cloudflare/hook.py'
## INFO: Using main config file /opt/dehydrated/config
 + CloudFlare hook executing: startup_hook
 + Creating chain cache directory /opt/dehydrated/chains
Processing code.example.com
 + Creating new directory /opt/dehydrated/certs/code.example.com ...
 + Signing domains...
 + Generating private key...
 + Generating signing request...
 + Requesting new certificate order from CA...
 + Received 1 authorizations URLs from the CA
 + Handling authorization for code.example.com
 + 1 pending challenge(s)
 + Deploying challenge tokens...
 + CloudFlare hook executing: deploy_challenge
 + Creating TXT record: code.example.com => 8FWozOTG6G7zCTs7zQJWQ34OK3sLFgJUzAGLjbscDPs
 + Challenge: nONCKnH5i7U3CfAQN444-IjR8DhXYPdd1-2vSLH4F7A
 + Unable to locate record named _acme-challenge.code.example.com
 + TXT record created, CFID: 8bba036b11b3533c15ebb2ce30fc8a4f
 + Settling down for 10s...
 + Responding to challenge for code.example.com authorization...
 + Challenge is valid!
 + Cleaning challenge tokens...
 + CloudFlare hook executing: clean_challenge
 + Deleted TXT _acme-challenge.code.example.com, CFID 8bba036b11b3533c15ebb2ce30fc8a4f
 + Requesting certificate...
 + Checking certificate...
 + Done!
 + Creating fullchain.pem...
 + CloudFlare hook executing: deploy_cert
 + ssl_certificate: /opt/dehydrated/certs/code.example.com/fullchain.pem
 + ssl_certificate_key: /opt/dehydrated/certs/code.example.com/privkey.pem
 + Done!
Processing ubcode.example.com
 + Creating new directory /opt/dehydrated/certs/ubcode.example.com ...
 + Signing domains...
 + Generating private key...
 + Generating signing request...
 + Requesting new certificate order from CA...
 + Received 1 authorizations URLs from the CA
 + Handling authorization for ubcode.example.com
 + 1 pending challenge(s)
 + Deploying challenge tokens...
 + CloudFlare hook executing: deploy_challenge
 + Creating TXT record: ubcode.example.com => XuJ-ew6NftVdV1JbQrrBqJ6F-GL9yQf0zNwF0l5jhOg
 + Challenge: GouLgn8g2KM5FPocZcMkMHmXtMOSKsS5d7MVSrx5qT4
 + Unable to locate record named _acme-challenge.ubcode.example.com
 + TXT record created, CFID: efc3b9608a42101d4b31c727a8d62678
 + Settling down for 10s...
 + The DNS response does not contain an answer to the question: _acme-challenge.ubcode.example.com. IN TXT. Retrying query...
 + DNS not propagated, waiting 30s...
 + The DNS response does not contain an answer to the question: _acme-challenge.ubcode.example.com. IN TXT. Retrying query...
 + DNS not propagated, waiting 30s...
 + Responding to challenge for ubcode.example.com authorization...
 + Challenge is valid!
 + Cleaning challenge tokens...
 + CloudFlare hook executing: clean_challenge
 + Deleted TXT _acme-challenge.ubcode.example.com, CFID efc3b9608a42101d4b31c727a8d62678
 + Requesting certificate...
 + Checking certificate...
 + Done!
 + Creating fullchain.pem...
 + CloudFlare hook executing: deploy_cert
 + ssl_certificate: /opt/dehydrated/certs/ubcode.example.com/fullchain.pem
 + ssl_certificate_key: /opt/dehydrated/certs/ubcode.example.com/privkey.pem
 + Done!
Processing example.com
 + Creating new directory /opt/dehydrated/certs/example.com ...
 + Signing domains...
 + Generating private key...
 + Generating signing request...
 + Requesting new certificate order from CA...
 + Received 1 authorizations URLs from the CA
 + Handling authorization for example.com
 + 1 pending challenge(s)
 + Deploying challenge tokens...
 + CloudFlare hook executing: deploy_challenge
 + Creating TXT record: example.com => TB2owBPoTysC6r1c5mUBnxZgKQuu4OmRDklPN9zADyQ
 + Challenge: 2vebQ4X3RyqUzV1qUJXNbZPD15pvyPDpwLIERRa21BQ
 + Unable to locate record named _acme-challenge.example.com
 + TXT record created, CFID: ac73764513bc4e7a4812212c3e8cfc28
 + Settling down for 10s...
 + DNS not propagated, waiting 30s...
 + DNS not propagated, waiting 30s...
 + Responding to challenge for example.com authorization...
 + Challenge is valid!
 + Cleaning challenge tokens...
 + CloudFlare hook executing: clean_challenge
 + Deleted TXT _acme-challenge.example.com, CFID ac73764513bc4e7a4812212c3e8cfc28
 + Requesting certificate...
 + Checking certificate...
 + Done!
 + Creating fullchain.pem...
 + CloudFlare hook executing: deploy_cert
 + ssl_certificate: /opt/dehydrated/certs/example.com/fullchain.pem
 + ssl_certificate_key: /opt/dehydrated/certs/example.com/privkey.pem
 + Done!
 + CloudFlare hook executing: exit_hook
[::] buntin@example.com:/opt/dehydrated (master %) $ ls
```

è¨¼æ˜æ›¸ã®æ›´æ–°ã¯ã“ã‚Œã§çµ‚ã‚ã‚Šã§ã™ã€‚

![03_welcome-dehydrated/welcome-dehydrated-info](/images/03_welcome-dehydrated/welcome-dehydrated-info.webp)
å”¯ã€…ã€ç¥ã€‚ä»¥ä¸Šã§ã™ã€‚(nginx ã¸ã®é©ç”¨ã€ãƒªãƒ­ãƒ¼ãƒ‰ã‚’ãŠå¿˜ã‚Œãªã)

ã“ã‚Œã§ã‚ˆã‚Šå®‰å…¨ã§ç°¡æ½”ãªè¨¼æ˜æ›¸æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ•´ç†ã§ãã¾ã—ãŸã€‚

æ¯å›è¨¼æ˜æ›¸æ›´æ–°ã®ãŸã³ã«æ–°ã—ã„æ–¹æ³•ã«æ‰‹ã‚’å‡ºã—ã¦ãã¾ã—ãŸãŒã€ã—ã°ã‚‰ãã¯å¤‰æ›´ã„ã‚‰ãªã„ãã‚‰ã„å …ç‰¢ãªã®ãŒã§ããŸã¨æ€ã„ã¾ã™ã€‚

ã‚ã¨ã¯ã€`cd /opt/dehydrated/ && ./dehydrated -c -k 'hooks/cloudflare/hook.py' -t dns-01 && systemctl reload nginx`ã‚’cronã«å…¥ã‚Œã¦ãŠããªã©ã™ã‚Œã°OKã§ã™ã€‚

è‡ªåˆ†ã§Denoè£½ã®hooksã‚’ä½œã‚ŠãŸã„ã¨ã„ã†é¡˜æœ›ãŒã˜ã‚ã˜ã‚æ¥ã¦ã‚‹ã®ã§ã€ãã®ã†ã¡ä½œã‚ã†ã‹ã¨æ€ã„ã¾ã™ã€‚(`-k "hooks/deno-dehydrated-hooks/hook.ts"`ã¨ã‹ã‚„ã£ã¦ã¿ãŸã„)

ã§ã¯ï¼
