---
title: Cloudflare Zero Trust, Tunnel ã§ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚»ã‚­ãƒ¥ã‚¢ã«é…ä¿¡ã™ã‚‹
description: Cloudflare Tunnelã§å…¬é–‹ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ã€Cloudflare Zero Trustã§ã®èªè¨¼ã«ã‚ˆã‚Šä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
date: 2025-04-10
categories: ['å·¥ä½œ','Linux','Web']
tags: ['ArchLinux','Nginx','Cloudflare','Zero Trust']
---

## ã¯ã˜ã‚ã«

#### !æ³¨æ„! Cloudflareã«ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã‚’ç§»ã—ã¦ã„ã‚‹å‰æã®å†…å®¹ã¨ãªã‚Šã¾ã™ â€»1


ä»¥å‰æ­»ã‚“ã OracleLinux,RHEL9ã‚µãƒ¼ãƒãƒ¼ã§ã€`raw.` ã¨ã„ã†ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ã„ã€ç”»åƒã‚„ã€å…¬é–‹éµãƒ•ã‚¡ã‚¤ãƒ«ã€CMSç”¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãªã©ã‚’é…ä¿¡ã—ã¦ã„ã¾ã—ãŸã€‚
ãã‚ŒãŒæ­»ã‚“ã§ã‹ã‚‰ã€ã—ã°ã‚‰ãã®é–“æ”¾ç½®çŠ¶æ…‹ã ã£ãŸã®ã§ã™ãŒã€æœ€è¿‘ã¡ã‚‡ã£ã¨ãã®æ©Ÿèƒ½ãŒæ¬²ã—ããªã£ãŸãŸã‚ã€å¾©æ´»ã•ã›ã¾ã™ã€‚

ã¾ãŸã€`secret-raw` ã¨ã„ã†ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ã„ã€å¤–ã«ã„ã‚‹ã¨ãã‚„ã€éµã‚’æŒã£ã¦ãã¦ã„ãªã„ç«¯æœ«ã§ã€p12ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã®ç§˜å¯†æƒ…å ±ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
å½“ç„¶ã§ã™ãŒã€ç§˜å¯†æƒ…å ±ã¯èªè¨¼ã‚’é€šã˜ã¦è‡ªåˆ†ã‚„å‹äººã®ãŸã‚ã ã‘ã«å…¬é–‹ã—ãŸã„ã§ã™ã€‚ãªã‚“ãªã‚‰ã€githubã®ã‚ªãƒ¼ã‚¬ãƒŠã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ã¦ãƒ¡ãƒ³ãƒãƒ¼ã‚„å†…éƒ¨ã®ACLã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚’è¡Œã†ãªã‚“ã¦ã“ã¨ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
ä¸€æ—¦ã¯githubãªã©ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ã‚’ä½¿ã†ã‚’ç›®æ¨™ã¨ã—ã¾ã™ã€‚

ä¾‹: å¤–å‡ºå…ˆã®ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‹ã‚‰ã€mTLSã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„

ãã®ãŸã‚ã€2ã¤ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ã£ã¦ã€ãã‚Œãã‚Œå…¬é–‹ç”¨ãƒ»ç§˜å¯†ç”¨ã§åˆ†ã‘ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```
secret-raw.domain.tld   ç§˜å¯†(èªè¨¼å¿…é ˆ)ç”¨
raw.domain.tld          å…¬é–‹ç”¨
```

ã¨ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

`secret-raw.` ã®æ–¹ã«ã¤ã„ã¦ã¯ã€
ã¾ãŸã€80,443ãŒã™ã§ã«è¤‡æ•°ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ›ã‚¹ãƒˆã¨ã—ã¦ä½¿ã‚ã‚Œã¦ã„ã‚‹ãŸã‚ã€ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²ããŸã‚ã«ã€ãƒãƒ¼ãƒˆã”ã¨åˆ†ã‘ã¦é‹ç”¨ã—ã¾ã™ã€‚

ä½™è«‡ã§ã™ãŒã€æœ¬æ¥ã¯ã€`secret-raw.domain.tld` ã¯ã€ `secret.raw.domain.tld` ã¨ã™ã‚‹äºˆå®šã§ã—ãŸã€‚ã—ã‹ã—ã€.ã§åŒºåˆ‡ã‚‹ã¨ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰è¨¼æ˜æ›¸ãŒä½¿ãˆãªããªã‚Šã€ãƒˆãƒ³ãƒãƒ«ã®è¨¼æ˜æ›¸æ¤œè¨¼ãŒå†…éƒ¨ã§å¤±æ•—ã™ã‚‹ã“ã¨ã§ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰æ¥ç¶šä¸å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚


â€»1 ä½œæ¥­å†…å®¹2

## å¯¾å¿œæ–¹é‡

ä»¥ä¸‹ã®ã‚·ãƒŠãƒªã‚ªã§è¡Œãã¾ã™ã€‚

1. `/var/www/secret-raw` ã‚’å…¬é–‹ã™ã‚‹ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ›ã‚¹ãƒˆ(secret-raw)ã‚’ã€20001ãƒãƒ¼ãƒˆã§å…¬é–‹
2. 20001ãƒãƒ¼ãƒˆã‚’Cloudflare Tunnelã§å…¬é–‹
3. `/var/www/raw`ã‚’å…¬é–‹ã™ã‚‹ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ›ã‚¹ãƒˆ(raw)ã‚’80,443ãƒãƒ¼ãƒˆã§å…¬é–‹
4. Cloudflare Tunnelã§å…¬é–‹ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ã€Clouflare Zero Trustã§ä¿è­·
5. Zero Trustã«ã¦ã€å¯¾è±¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³(ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³)ã‚’Githubã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ãªã©ã‹ã‚‰åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

## ä½¿ç”¨æŠ€è¡“è§£èª¬

### Cloudflared(Cloudflare Tunnel)

å¤§æ˜”OracleLinuxã‚’ä½¿ã£ã¦ã„ãŸã¨ãã«ã‚ˆãä½¿ã£ã¦ã„ãŸãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
åå‰ã®é€šã‚Šã€Cloudflareã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

Cloudflareã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ãƒ—ãƒ­ã‚­ã‚·(CDN)ã‚’ä½¿ã†ã¨ã€ã‚µãƒ¼ãƒãƒ¼ã®å®ŸIPã‚’éš ã™ã“ã¨ãŒã§ãã¾ã™ã€‚  
ã“ã‚Œç›®çš„ã§å¤§ä½“ã®çŠ¯ç½ªã‚µã‚¤ãƒˆ(æ¼«ç”»rawãªã©)ã¯Cloudflareã‚’ä½¿ç”¨ã™ã‚‹ã‚ã‘ã§ã™ãŒã€ã“ã‚Œã‚’å¿œç”¨ã—ã¾ã™ã€‚
ãã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã‚¨ãƒƒã‚¸ã¨ã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’Cloudflaredã‚’é€šã—ãŸæš—å·åŒ–é€šä¿¡ã§ãƒ—ãƒ­ã‚­ã‚·ã™ã‚‹ã“ã¨ã§ã€ç–‘ä¼¼çš„ã«ã‚µãƒ¼ãƒãƒ¼å†…ã«ãƒˆãƒ³ãƒãƒ«ã‚’é€šã™ã“ã¨ãŒã§ãã¾ã™ã€‚

æ­£ç¢ºã«ã¯ã€Cloudflareã‚µãƒ¼ãƒãƒ¼ã¨Cloudflaredé–“ã§ãƒˆãƒ³ãƒãƒ«ãŒé€šã‚‹ã®ã§ã™ãŒã€Cloudflareã‚’ä½¿ã£ã¦CDNãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ã†ã¨ã€è¡¨å‘ãã¯Cloudflareã«ã‚ˆã£ã¦ãƒ—ãƒ­ã‚­ã‚·ã•ã‚Œã¦ã„ã‚‹ãŸã ã®ã‚µã‚¤ãƒˆã®ã‚ˆã†ã«è¦‹ã›ã‚‰ã‚Œã¾ã™ã€‚

ãã®ãŸã‚ã€22ãƒãƒ¼ãƒˆã‚’æŒ‡å®šã—ã¦ã€sshconfigã§ã¡ã‚‡ã£ã¨ã—ãŸãƒ—ãƒ­ã‚­ã‚·è¨­å®šã‚’æ›¸ãã ã‘ã§ã€ãã‚Œã‚’ä½¿ã£ã¦SSHã‚’ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

### Cloudflare Zero Trust (æ—§Cloudflare Access)

Zero Trustã®åŸºæœ¬æ¦‚å¿µãªã©ã¯ã€Cloudflareã®è¨˜äº‹ã‚’å‚ç…§ãã ã•ã„ã€‚

è‡ªåˆ†ã®Zero Trustãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’å®šç¾©ã€ãã®ä¸­ã§Googleã‚„Githubã‚’IdentityProviderã¨ã—ã¦ä½¿ç”¨ã—ã€ãã‚Œãã‚Œã®ãƒ¡ãƒ¼ãƒ«ã‚’è­˜åˆ¥å­ã¨ã—ã¦ãã‚Œãã‚Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™ºè¡Œã€ãã‚Œãã‚Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã©ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ãªã©ã‚’æŸ”è»Ÿã«ç®¡ç†ã§ãã¾ã™ã€‚

ã“ã¡ã‚‰ã‚’ä½¿ã†ã¨ã€Cloudflareã§å…¬é–‹(ãƒ—ãƒ­ã‚­ã‚·å¿…é ˆ)ã—ã¦ã„ã‚‹SaaSã‚„ã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã‚’ã€Cloudflareã®åŸºç›¤ã§èªè¨¼ã‚’ã—ãªã„ã¨ä½¿ãˆãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¾ãŸã€ç–‘ä¼¼çš„ãªãƒ©ãƒ³ãƒãƒ£ãƒ¼ã‚‚å±•é–‹ã§ãã¾ã™ã€‚  
https://???.cloudflareaccess.com/#/Launcher ãªã©ã®URLã‹ã‚‰ã€ãã‚Œãã‚Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é·ç§»ã§ãã‚‹ã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚

ä»¥ä¸‹ã¯ã€ã»ã¼ä¿å®ˆã•ã‚Œã¦ã„ãªã„ä»¥å‰ã®ç’°å¢ƒã®ãƒ©ãƒ³ãƒãƒ£ãƒ¼ã®ä¾‹ã§ã™ã€‚

![06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-access-launcher-sample-01](/images/06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-access-launcher-sample-01.webp)
![06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-access-launcher-sample-02](/images/06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-access-launcher-sample-02.webp)
![06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-access-launcher-sample-03](/images/06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-access-launcher-sample-03.webp)

### Nginx

ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã®Webã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦Nginxã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

## ä½œæ¥­å†…å®¹

### 1. Nginxã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æœ‰åŠ¹ã«ã—ãŸã€ãƒªã‚½ãƒ¼ã‚¹å…¬é–‹ç”¨VHã‚’ä½œæˆ

```
root@badcompany ~                                                                                 [18:27:55]
> # cd /etc/nginx/conf.d                                                                                    
root@badcompany /etc/nginx/conf.d                                                                                     [17:12:09]
> # ls -lah                                                                                                                     
total 56K
drwxr-xr-x 3 root root 4.0K Feb 28 17:05 .
drwxr-xr-x 3 root root 4.0K Feb 24 15:39 ..
-rw-r--r-- 1 root root 1.1K Feb 24 15:35 01_domain.tld.conf
-rw-r--r-- 1 root root  741 Sep 15 18:06 01_domain.tld.conf.20250224
-rw-r--r-- 1 root root 1.2K Feb 24 15:41 02_dash.domain.tld.conf
-rw-r--r-- 1 root root  981 Feb 25 11:48 03_kuma.domain.tld.conf
-rw-r--r-- 1 root root  714 Nov 24 01:19 03_kuma.domain.tld.conf.20250224
-rw-r--r-- 1 root root 1012 Nov 24 01:26 04_filebrowser.domain.tld.conf
-rw-r--r-- 1 root root 1.5K Feb 24 15:45 05_jupyterlab.domain.tld.conf
-rw-r--r-- 1 root root 1.4K Feb 24 15:45 06_code.domain.tld.conf
-rw-r--r-- 1 root root 1.5K Feb 26 10:56 07_buntin.code.domain.tld.conf
-rw-r--r-- 1 root root 1.5K Feb 26 10:56 07_buntin.code.domain.tld.conf.20250228
-rw-r--r-- 1 root root  759 Feb 25 11:50 08_raw.domain.tld.conf
drwxr-xr-x 2 root root 4.0K Feb 28 17:08 tunnels
root@badcompany /etc/nginx/conf.d                                                                                     [17:12:16]
> # cat 08_raw.domain.tld.conf                                                                                            
server {
    listen 80;
    server_name raw.domain.tld;

    access_log /var/log/nginx/raw.domain.tld_access.log main;
    error_log  /var/log/nginx/raw.domain.tld_error.log warn;

    return 301 https://raw.domain.tld$request_uri;
}

server {
    listen 443 ssl;
    server_name raw.domain.tld;

    ssl_certificate     /opt/dehydrated/certs/domain.tld/fullchain.pem;
    ssl_certificate_key /opt/dehydrated/certs/domain.tld/privkey.pem;

    access_log /var/log/nginx/raw.domain.tld_access.log main;
    error_log  /var/log/nginx/raw.domain.tld_error.log warn;

    location / {
        root /var/www/raw;

        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
    }
}
root@badcompany /etc/nginx/conf.d                                                                                     [17:12:19]
> # cd tunnels                                                                                                                  
root@badcompany /etc/nginx/conf.d/tunnels                                                                             [17:12:38]
> # vim 01_secret-raw.domain.tld.conf                                                                                     
root@badcompany /etc/nginx/conf.d/tunnels                                                                             [17:12:43]
> # cat 01_secret-raw.domain.tld.conf                                                                                     
server {
    listen 20001;
    server_name secret-raw.domain.tld;

    #ssl_certificate     /opt/dehydrated/certs/domain.tld/fullchain.pem;
    #ssl_certificate_key /opt/dehydrated/certs/domain.tld/privkey.pem;

    access_log /var/log/nginx/secret.domain.tld_access.log main;
    error_log  /var/log/nginx/secret.domain.tld_error.log warn;

    location / {
        root /var/www/secret-raw;

        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
    }
}
root@badcompany /etc/nginx/conf.d/tunnels                                                                             [17:12:46]
> #             root@badcompany /etc/nginx/conf.d/tunnels                                                         [18:34:43]
> # cd /etc/nginx/                                                                                          
root@badcompany /etc/nginx                                                                        [18:34:49]
> # cp -p nginx.conf{,.$(date "+%Y%m%d")}                                                                   
root@badcompany /etc/nginx                                                                        [18:34:59]
> # vim nginx.conf # è¿½åŠ ã§tunnelãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ã—ã¦æ–°è¦ã§nginxã®è¨­å®šã‚’ç½®ãå‡ºã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«å¤‰æ›´
root@badcompany /etc/nginx                                                                        [18:35:23]
> # diff nginx.conf.20250215 nginx.conf                                                                     
34a35
>     include /etc/nginx/conf.d/tunnels/*.conf;
root@badcompany /etc/nginx                                                                        [18:35:32]
> # nginx -t                                                                                                
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
root@badcompany /etc/nginx                                                                        [18:35:38]
> # systemctl reload nginx                                                                                  
root@badcompany /etc/nginx                                                                        [18:35:43]
> # systemctl status nginx                                                                                  
â— nginx.service - nginx web server
     Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; preset: disabled)
     Active: active (running) since Sat 2025-02-15 01:35:05 JST; 17h ago
 Invocation: b7b4fe898ef24286a1f8eb63fd5e9dda
    Process: 1460335 ExecStart=/usr/bin/nginx (code=exited, status=0/SUCCESS)
    Process: 1525037 ExecReload=/usr/bin/nginx -s reload (code=exited, status=0/SUCCESS)
   Main PID: 1460336 (nginx)
      Tasks: 3 (limit: 57486)
     Memory: 7.3M (peak: 9.1M)
        CPU: 10.903s
     CGroup: /system.slice/nginx.service
             â”œâ”€1460336 "nginx: master process /usr/bin/nginx"
             â”œâ”€1460337 "nginx: worker process is shutting down"
             â””â”€1525043 "nginx: worker process"

Feb 15 16:45:00 domain.tld nginx[1460337]: 2025/02/15 16:45:00 [error] 1460337#1460337: *5542 open() ">
Feb 15 16:51:07 domain.tld nginx[1460337]: 2025/02/15 16:51:07 [error] 1460337#1460337: *5553 open() ">
Feb 15 17:14:31 domain.tld nginx[1460337]: 2025/02/15 17:14:31 [error] 1460337#1460337: *5604 open() ">
Feb 15 18:06:16 domain.tld nginx[1460337]: 2025/02/15 18:06:16 [error] 1460337#1460337: *5670 open() ">
Feb 15 18:29:56 domain.tld nginx[1460337]: 2025/02/15 18:29:56 [error] 1460337#1460337: *5762 open() ">
Feb 15 18:29:56 domain.tld nginx[1460337]: 2025/02/15 18:29:56 [error] 1460337#1460337: *5763 open() ">
Feb 15 18:34:44 domain.tld nginx[1460337]: 2025/02/15 18:34:44 [error] 1460337#1460337: *5770 open() ">
Feb 15 18:35:43 domain.tld systemd[1]: Reloading nginx web server...
Feb 15 18:35:43 domain.tld nginx[1525037]: 2025/02/15 18:35:43 [notice] 1525037#1525037: signal proces>
Feb 15 18:35:43 domain.tld systemd[1]: Reloaded nginx web server.
```

![06_publish-web-with-cloudflare-zero-trust-and-tunnel/nginx-directory-index-test](/images/06_publish-web-with-cloudflare-zero-trust-and-tunnel/nginx-directory-index-test.webp)

OKãã†ã§ã™ã­

Nginxã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚„å®Ÿéš›ã®ç·¨é›†å†…å®¹ãªã©ã¯ã€ãƒ­ã‚°ã®é€”ä¸­ã‚’èª­ã‚“ã§ã„ãŸã ã‘ã‚‹ã¨ğŸ™‡â€â™‚ï¸

è‡ªå®…å›ç·š(â€»å¤©ä¸‹ã®ç©¶æ¥µã†ã‚“ã“ISP Nuroå…‰)ã®ãƒ«ãƒ¼ã‚¿ãƒ¼ã«ã‚ˆã‚‹ã€ãƒãƒ¼ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›ã®é…ä¸‹ã«ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼ã®è¨­å®šä¾‹ã¨ãªã‚Šã¾ã™ã€‚

å®Ÿéš›ã®ä½¿ç”¨ç’°å¢ƒã§ã¯ã€`/var/www/secret-raw` ã«ã¯ç§˜åŒ¿æ€§ã®é«˜ã„æƒ…å ±ãŒå…¥ã‚‹ã¯ãšãªã®ã§æ‰±ã„æ–¹ã«æ³¨æ„ã§ã™(Nginxã‚’ä½¿ã£ã¦é…ä¿¡ã—ã¦ã„ã‚‹æ™‚ç‚¹ã§å¯Ÿã—ã¦ãã ã•ã„)  
å¤–éƒ¨ã‹ã‚‰20001ç•ªãƒãƒ¼ãƒˆã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‚ˆã†ã«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚’ã‹ã‘ã‚‹ãã‚‰ã„ã¯å¿…è¦ã‹ã¨ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€`raw.`, `secret-raw.`ã®ä¸¡æ–¹ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚

rawãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¦ã„ãã€ã“ã“ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æƒ³å®šã§ã™ã€‚ãƒãƒ¼ãƒˆã‚’åˆ†ã‘ã¦ã„ã‚‹ãŸã‚ã€ã¾ã å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚

ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å®Ÿéš›ã«åˆ‡ã‚‹ã®ã¯æœ€å¾Œã«ã—ã¾ã™ã€‚

### 2. Cloudflare Tunnelã‚’ä½¿ã„ã€20001ãƒãƒ¼ãƒˆã‚’å…¬é–‹ã™ã‚‹

#### æ³¨æ„ Cloudflareã«NSã‚’ç§»ç®¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

> !æ³¨æ„! Cloudflareã«ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã‚’ç§»ã—ã¦ã„ã‚‹å‰æã¨ãªã‚Šã¾ã™ â€»1

å†’é ­ã®ä»¥ä¸Šã¯ã€ã“ã“ã«é–¢ä¿‚ã—ã¾ã™ã€‚ä»Šå›åˆ©ç”¨ã™ã‚‹CloudflareTunnel, ZeroTrustã¯ã€Cloudflareã«ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã‚’ç§»ã—ã¦ä½¿ãˆã‚‹Cloudflareç‹¬è‡ªã®æ©Ÿèƒ½ãªã®ã§ã€ã“ã“ã‹ã‚‰ã¯ãã®å‰æã‚ã‚Šãã§é€²ã‚ã¦ã„ãã¾ã™ã€‚  
ã¾ãŸã€CloudflareDashboardå†…ã®æ¨©é™å‘¨ã‚Šã¯è€ƒãˆã¾ã›ã‚“ã€‚å…¨æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å‰æã®è©±ã§ã™ã€‚é–‹ç™ºç’°å¢ƒã§ã¯é–¢ä¿‚ãªã„è©±ã ã¨æ€ã„ã¾ã™ãŒå¿µã®ãŸã‚ã€‚

#### 1. cloudflaredã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Cloudflaredã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã«ã¯Archã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

```
â¯ paru -Syu cloudflared
:: Synchronizing package databases...
 core is up to date
 extra is up to date
 multilib is up to date
:: Starting full system upgrade...
resolving dependencies...
looking for conflicting packages...

Packages (1) cloudflared-2025.2.0-1

Total Download Size:    7.19 MiB
Total Installed Size:  24.88 MiB

:: Proceed with installation? [Y/n] 
:: Retrieving packages...
 cloudflared-2025.2.0-1...     7.2 MiB  9.75 MiB/s 00:01 [##############################] 100%
(1/1) checking keys in keyring                           [##############################] 100%
(1/1) checking package integrity                         [##############################] 100%
(1/1) loading package files                              [##############################] 100%
(1/1) checking for file conflicts                        [##############################] 100%
(1/1) checking available disk space                      [##############################] 100%
:: Processing package changes...
(1/1) installing cloudflared                             [##############################] 100%
:: Running post-transaction hooks...
(1/1) Arming ConditionNeedsUpdate...
:: Looking for PKGBUILD upgrades...
:: Looking for AUR upgrades...
:: Looking for devel upgrades...
:: Resolving dependencies...
:: Calculating conflicts...
:: Calculating inner conflicts...
```

#### 2. Cloudflareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ãƒˆãƒ³ãƒãƒ«ã‚’ä½œæˆ

Cloudflareã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ãƒˆãƒ³ãƒãƒ«ã‚’ç®¡ç†ã—ã¾ã™ã€‚

CLIã‹ã‚‰ã‚„ã‚‹æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ãŒã€ãƒˆãƒ³ãƒãƒ«ã®æƒ…å ±ã‚’ã‚³ãƒ³ãƒ‘ãƒã‹ã‚‰è§¦ã‚Œã‚‹ãƒ¡ãƒªãƒƒãƒˆãŒãƒ‡ã‚«ã™ãã‚‹ã®ã§ã€ä»Šå›ã¯ã‚³ãƒ³ãƒ‘ãƒã§è¡Œãã¾ã™ã€‚  
ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ»ãƒ­ãƒ¼ã‚«ãƒ«ç®¡ç†ã¨ã„ã†åç›®ã§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã‚‚é¸æŠåˆ¶ã¨ãªã£ã¦ã„ã¦ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«(ã‚³ãƒ³ãƒ‘ãƒ)æ¨å¥¨ã¨ã¯ã£ãã‚Šæ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚  
ã“ã“ã¯ã€æµçŸ³ã«ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã£ã½ã„æ–¹ã‚’é¸ã‚“ã§ãŠãã¾ã™ã€‚

ã¾ãŸã€Tunnelä½œæˆæ™‚ãªã©ã«CNAMEã‹ãªã‚“ã‹ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒCloudflareå´ã§è²¼ã‚‰ã‚Œã¾ã™

ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‹ã‚‰ã€ã€ŒCloudflare Accessã€ã‚’é¸æŠã™ã‚‹ã¨ã€ZeroTrustã«çµ±åˆã•ã‚ŒãŸæ—¨ãŒè¡¨ç¤ºã•ã‚Œã¦ZeroTrustã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«é€²ã¿ã¾ã™ã€‚

æ¬¡ã«ã€ã€ŒZero Trustã®æ¦‚è¦ > ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ > Tunnels(ãƒˆãƒ³ãƒãƒ«)ã€ã«é€²ã¿ã¾ã™ã€‚

![06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-network-tunnels-01](/images/06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-network-tunnels-01.webp)

ã€Œãƒˆãƒ³ãƒãƒ«ã‚’è¿½åŠ ã™ã‚‹ã€ã‹ã‚‰ã€ãƒˆãƒ³ãƒãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚

![06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-02](/images/06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-02.webp)


Cloudflaredã‚’ä½¿ç”¨ã—ã¾ã™  
ã¨ã„ã†ã‹ã€WARPã‚’ä½¿ã£ã¦ã„ã‚‹äººã£ã¦ã©ã‚Œãã‚‰ã„ã„ã‚‹ã‚“ã§ã™ã‹ã­ï¼Ÿ
ä»–ã®ãƒã‚¿ã§ã‚‚è¨€ã†ã¨æ€ã„ã¾ã™ãŒã€Cloudflareã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®åŠ›ã§ã‚´ãƒªæŠ¼ã—ã¦ã„ã‚‹ã ã‘ã§ã€tailscaleã®å®Œå…¨ä¸‹ä½äº’æ›ã ã¨æ€ã†ã®ã§ã™ãŒã€‚

![06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-001](/images/06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-001.webp)
![06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-002-tunnel-config](/images/06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-002-tunnel-config.webp)

ãƒˆãƒ³ãƒãƒ«åã‚’æ±ºã‚ã€cloudflaredã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã®æ‰‹é †ã®éƒ¨åˆ†ã‚’ã‚·ã‚§ãƒ«ã«ã‚³ãƒ”ãƒšã—ã¾ã™

```
> # sudo cloudflared service install KEYKEYKEYKEYKEY
2025-03-26T04:25:48Z INF Using Systemd
2025-03-26T04:25:49Z INF Linux service for cloudflared installed successfully
```

![06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-003-connected](/images/06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-003-connected.webp)

ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ›ã‚¹ãƒˆã®ä½œæˆã¨ã€ãƒãƒªã‚·ãƒ¼ã®å®šç¾©ã‚’è¡Œã„ã¾ã™ã€‚
ã“ã“ã§ä½œæˆã—ã¦ã„ã‚‹ã®ã¯ã€Cloudflare Zero Trustã§ã„ã†ã¨ã“ã‚ã®ã€Œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ã§ã™ã€‚

![06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-004-create-public-host](/images/06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-004-create-public-host.webp)
![06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-005](/images/06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-005.webp)

ç”»åƒã§ã€Œsecret.rawã€ã¨ãªã£ã¦ã„ã‚‹ã®ã¯è¦‹ãªã‹ã£ãŸã“ã¨ã«ã—ã¦ãã ã•ã„ã€‚
è¨¼æ˜æ›¸ã®ä»¶ã‚’å¾Œã‹ã‚‰æ°—ã¥ã„ã¦ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å¤‰æ›´ã™ã‚‹ã¾ã§æ°—ã¥ã‹ãšã‚¹ã‚¯ã‚·ãƒ§æ’®ã£ã¡ã‚ƒã£ã¦ã¾ã—ãŸã€‚
ç”»åƒã®ã¨ã“ã‚ã¯æœ¬æ¥ã€Œsecret-rawã€ã«ãªã‚‹ã¯ãšã§ã™ã€‚

secret-raw.domain.tldã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒšãƒ¼ã‚¸ã«é·ç§»ã—ã¾ã™ã€‚

![06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-0008-access-auth](/images/06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-0008-access-auth.webp)

githubã‚’é¸æŠã™ã‚‹ã¨ã€githubã§ã®èªè¨¼ç”»é¢ã«ç§»ã‚Šã¾ã™ã€‚

![06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-009-oauth-page](/images/06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-009-oauth-page.webp)

githubã®èªè¨¼ãŒå®Œäº†ã™ã‚‹ã¨ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æƒ…å ±ãŒCloudflareã«æ¸¡ã•ã‚Œã¾ã™ã€‚ãã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ã‚‚ã¨ã«ã€ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ›ã‚¹ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™æ™‚ã«ä½œæˆã—ãŸãƒ«ãƒ¼ãƒ«ã€ãƒãƒªã‚·ãƒ¼ã«å¾“ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯å¦ãŒåˆ¤æ–­ã•ã‚Œã¾ã™ã€‚

â€» è¬ã®ãƒ‰ãƒ¡ã‚¤ãƒ³éš ã—ãŒå¤šãã¦ç”³ã—è¨³ãªã„ã§ã™ã€‚ä»Šå¹´ã«å…¥ã£ã¦ã™ãã‚ãŸã‚Šã«ã€ä»²é–“å†…ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«å•é¡ŒãŒã‚ã£ãŸãŸã‚ã€ä¸€å¿œéš ã—ã¦ã„ã¾ã™ã€‚

![06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-006-secret-raw](/images/06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-006-secret-raw.webp)

ã“ã‚Œã§secret-rawã®æ–¹ã¯èªè¨¼ä»˜ãã§å…¬é–‹ã¾ã§ã„ã‘ã¾ã—ãŸã€‚

###  3. raw. ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ

raw. ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ã€ã¨ã‚Šã‚ãˆãšã‚µãƒ¼ãƒãƒ¼ã«å‘ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Nginxã®ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ›ã‚¹ãƒˆã§ã€Hostãƒ˜ãƒƒãƒ€ãƒ¼ã‚’åˆ©ç”¨ã—ãŸåˆ†å²ã¯Cloudflareè¶Šã—ã§ã‚‚æ©Ÿèƒ½ã™ã‚‹ãŸã‚ã€æ§‹ã‚ãšwwwã«å¯¾ã™ã‚‹Cloudflareãƒ—ãƒ­ã‚­ã‚·æœ‰ã‚Šã®CNAMEãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

ä¸€å¿œã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã‹ç¢ºèªã—ã¾ã™ã€‚

![06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-007-raw](/images/06_publish-web-with-cloudflare-zero-trust-and-tunnel/cf-zerotrust-tunnel-bc-007-raw.webp)

ã“ã“ã¾ã§ã§ã€`secret-raw.` ã¨ã€`raw.`ã«ã¤ã„ã¦ã€Cloudflareã®ãƒ—ãƒ­ã‚­ã‚·ã‚’ä»‹ã—ã¦ãƒªã‚½ãƒ¼ã‚¹ã®å…¬é–‹ã¾ã§å®Œäº†ã—ã¾ã—ãŸ

è‡ªåˆ†ãŒèª¤ã£ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’å¤‰æ›´ã—ãŸã‚Šã—ãªã‘ã‚Œã°å®‰å…¨ãªæ§‹æˆã‹ã¨æ€ã„ã¾ã™ã€‚
ã§ã¯ã€‚

## å‚è€ƒ

[Cloudflare Tunnel Â· Cloudflare Zero Trust docs](https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/)
[ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¨ã¯ï¼Ÿ | Cloudflare](https://www.cloudflare.com/ja-jp/learning/security/glossary/what-is-zero-trust/)
