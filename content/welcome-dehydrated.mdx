---
title: '[dehydrated]ãƒ–ãƒ­ã‚°ã®SSLè¨¼æ˜æ›¸ã‚’ã‚ˆã‚Šå¼·å›ºã«è‡ªå‹•æ›´æ–°ã—ãŸã„'
description: SSL è¨¼æ˜æ›¸ã‚’ certbot ã§ cron ã™ã‚‹ã ã‘ã®ãƒãƒ³ ğŸ™† ã‚¹è„³æ­»æ§‹æˆã§ã¯ãªãã€ã¡ã‚ƒã‚“ã¨ CloudflareAPI ã‚’åˆ©ç”¨ã—ãŸå …ç‰¢ãªè¨¼æ˜æ›¸è‡ªå‹•æ›´æ–°ç’°å¢ƒã‚’ä½œæˆã—ãŸã„ã€‚
date: 2024-03-08
tags: ['dehydrated', 'Cloudflare']
categories: ['å·¥ä½œ', 'SSL']
keywords: ['dehydrated', "Let's Encrypt", 'certbot', 'SSL', 'Cloudflare', 'è¨¼æ˜æ›¸', 'æ›´æ–°', 'ã‚¹ã‚¯ãƒªãƒ—ãƒˆ']
---

# ã‚ˆã‚Šå¼·å›ºã«ï¼Ÿï¼Ÿ

ãªã‚“ã¦è¨€ã£ãŸï¼Ÿ

**SSL è¨¼æ˜æ›¸ã‚’ certbot ã§ cron ã™ã‚‹ã ã‘ã®ãƒãƒ³ ğŸ™† ã‚¹è„³æ­»æ§‹æˆã§ã¯ãªãã€ã¡ã‚ƒã‚“ã¨ CloudflareAPI ã‚’åˆ©ç”¨ã—ãŸå …ç‰¢ãªè¨¼æ˜æ›¸è‡ªå‹•æ›´æ–°ç’°å¢ƒã‚’ä½œæˆã—ãŸã„ã€‚**

ä½•ã“ã„ã¤ï¼Ÿã£ã¦æ„Ÿã˜ã§ã—ã‚‡ã†ã‹ã€‚

ç§ã«ã¨ã£ã¦ã€è„³æ­»æ§‹æˆã¯ http æ¥ç¶šã¨ãƒ‰ãƒ¡ã‚¤ãƒ³æŒ‡å®šã«ã‚ˆã‚‹ certbot ã® SSL è¨¼æ˜æ›¸ç™ºè¡Œã§ã™ã€‚ã‚ˆãè¡Œã‚ã‚Œã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚ãã‚Œã‚’ cron ã—ãŸã‚Šã‚‚ã§ã™ã€‚

è‡ªåˆ†ã¯ã€ã§ãã‚Œã°é™ã‚Šãªã CA ã‚„ãƒ‰ãƒ¡ã‚¤ãƒ³é–¢é€£ä»¥å¤–ã®æ§‹æˆã¯ã‹ãªã‚ŠæŠ€è¡“çš„ã«å …ã„ã€ã¨ã„ã†ã‹ã€ã‚ˆã‚Šæ©Ÿæ¢°çš„ãªã‚‚ã®ãŒå¥½ãã§ã™ã€‚
ä»Šå›ã¯è§£æ±ºç­–ãŒå‡ºã¦ãã¾ã™ã®ã§æ¥½ã—ã¿ã«ã—ã¦ã¦ãã ã•ã„ã€‚

ä»Šå›ã®ç§ã®ç’°å¢ƒã‚’ç´¹ä»‹ã—ã¦ãŠãã¾ã™ã€‚
ã“ã®ãƒ–ãƒ­ã‚°ã¨ã¯åˆ¥ã®ç’°å¢ƒã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã‚’åŸ·ç­†ã—ã¦ã„ã‚‹ç’°å¢ƒã§ã™ã­ã€‚

ãƒ–ãƒ­ã‚°ã®æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã¯åˆ¥ã®è¨˜äº‹ã§ã„ã¤ã‹ç´¹ä»‹ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

ã‚ã€ã€Œã‚ˆã‚Šå¼·å›ºã«ã€ã‚’ã€Œã‚ˆã‚Šæ¨©å¨çš„ãª CA ã‹ã‚‰ã®ç„¡æ–™è¨¼æ˜æ›¸ã®å…¥æ‰‹ã™ã‚‹ã€ã¨ç©ºè¦‹ã—ãŸæ–¹ã¯ãŠå¸°ã‚Šãã ã•ã„ã€‚ãã®ã‚ˆã†ãªæ–¹æ³•ã¯çŸ¥ã‚Šã¾ã›ã‚“ã€‚

# ç’°å¢ƒ

**è‡ªå®… LAN å†…**

- ONU(Nuro) ã»ã¼å›ºå®š IP
- Red Hat Enterprise Linux 9.3 (x86_64)
- Ubuntu 22 LTS (x86_64)
- Miracle Linux 9.2 (x86_64)

ã“ã‚Œã‚‰ã«å¯¾ã—ã¦ã€ZTE è£½ã® Nuro ã® ONU ã§ãƒãƒ¼ãƒˆè§£æ”¾ã‚’è¡Œã„ã€ãã‚Œãã‚Œã®ã‚µãƒ¼ãƒãƒ¼ã‚’å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ä½¿ç”¨ç”¨é€”ã¯ä¸»ã«ã€é–‹ç™ºç”¨ã€web ã‚µãƒ¼ãƒãƒ¼ç”¨ã€è¶£å‘³ç”¨ã¨ãªã‚Šã¾ã™ã€‚
ã‚²ãƒ¼ãƒ ç”¨ã®ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ãŸã‚Šã‚‚ã—ã¦ã„ã¾ã™ã€‚

RHEL ã«å¼·ã„ CPU ãŒä¹—ã£ã¦ã„ã‚‹ãŸã‚ã€ã»ã¼ãã‚ŒãŒãƒ¡ã‚¤ãƒ³ã§ã™ã€‚

ã“ã‚Œã‚‰ã«å¯¾ã—ã¦ã€ã‚ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å–å¾—ã—ã€Cloudflare ã§ DNS ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚‚åˆ¥è¨˜äº‹ã«ãªã‚‹ã¨æ€ã„ã¾ã™ãŒã€Cloudflare ã¯ç¥ã§ã™ã€‚
ã§ã™ã®ã§ã€DNS,CDN,SSL,DDoS å¯¾ç­–ãªã©ã€ç§ã®ã‚¤ãƒ³ãƒ•ãƒ©ã¯ã ã„ã¶ Cloudflare ä¾å­˜æ°—å‘³ã§ã™ã®ã§ã€çœŸä¼¼ã¯ã‚ã¾ã‚ŠãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚ã€‚

# ç¾çŠ¶è§£èª¬ãƒ»ä»Šã¾ã§ã®è¨¼æ˜æ›¸æ›´æ–°

èª¬æ˜ã«è‡ªå®…ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ã†ã®ã‚‚å¤‰ãªã®ã§ã€ã“ã“ã§ã¯ `example.com`ã¨è¨€ã†ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹å‰æã¨ã—ã¾ã™ã€‚

ã¾ãšã€è‡ªå®…å›ç·šã§ãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ©ãƒ³ã§ã‚‚ãªã„ã®ã§ ISP ã‹ã‚‰æ‰•ã„å‡ºã•ã‚ŒãŸ IP ãŒå¤‰ã‚ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

Nuro ã‚’å°å…¥ã—ã¦æ—© 5 å¹´ã»ã©çµŒã¡ã¾ã™ãŒã€ä»Šã®æ‰€ä¸€åº¦ã—ã‹å¤‰åŒ–ã—ã¦ã„ã¾ã›ã‚“ã€‚

ã—ã‹ã—ã€ãã‚Œã§ã‚‚ã‚„ã¯ã‚Šãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ IP ãŒæ©Ÿæ¢°çš„ã«ã¤ãªãŒã£ã¦ã„ãªã„ã¨å®‰å¿ƒã§ããªã„ç§ã¯ã€Cloudflare API ã‚’åˆ©ç”¨ã—ãŸãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ DNS ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

ä»Šã¾ã§ã¯ã€è¤‡æ•°ã®ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¯¾ã—ã¦ã€certbot ã§è¨¼æ˜æ›¸ã‚’ã‚µãƒ¼ãƒãƒ¼å†…ã‹ã‚‰å–å¾—ã™ã‚‹ã‚‚ã®ã¨ã€ZeroSSL ã‚’åˆ©ç”¨ã™ã‚‹ 2 ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ··åœ¨ã—ã¦ã„ã¾ã—ãŸã€‚

> [certbot](https://certbot.eff.org/)- Let's Encrypt ã®å…¬å¼ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

> [ZeroSSL](https://zerossl.com/) > [ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç„¡æ–™ã§ç°¡å˜ã«è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã§ãã‚‹ ZeroSSL | DevelopersIO](https://dev.classmethod.jp/articles/zerossl-a-free-and-easy-way-to-issue-certificates-from-your-browser/)

ãƒ‰ãƒ¡ã‚¤ãƒ³ã”ã¨ã«ã€ä½•ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã®ã‹ã‚ã‹ã‚Šã«ããã€ã‹ã¤ ZeroSSL ã«ã¤ã„ã¦ã¯è¨¼æ˜æ›¸ã®æ›´æ–°æ™‚ã®èª²é‡‘ã®å¼·åˆ¶æ„Ÿ(ã†ã¾ãã‚„ã‚Œã°(æœ¬æ¥ã¯)æ‰•ã‚ãªãã¦è‰¯ã„)ãŒã†ã–ã‹ã£ãŸã®ã§ã€ã‚„ã‚ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰æ‰‹é ƒã«ã¨ã£ã¦æ¥ã‚Œã‚‹ã®ã¯è‰¯ã„ã‚“ã§ã™ã‘ã©ã­ã€‚

**ã§ï¼Ÿ**

çµå±€ã“ã„ã¤ã‚‰ãŒã‚„ã£ã¦ã‚‹ã®ã¯ ACME ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«æº–ã˜ãŸè‡ªå‹•çš„ãªè¨¼æ˜æ›¸ã®ç™ºè¡Œã§ã™ã€‚å‰ã„ã®ã¯ CA ã§ã‚ã£ã¦ã“ã„ã¤ã‚‰ã§ã¯æ±ºã—ã¦ã‚ã‚Šã¾ã›ã‚“ã€‚ã„ã‚„ ZeroSSL ã¯ãƒ¯ãƒ³ãƒãƒ£ãƒ³å‰ã„ã‹ï¼Ÿ

ã¾ãŸã€certbot ã¯ã‚„ã‚‹ã“ã¨ã«æ¯”ã¹ã¦å‰ãé«˜ç´šã§å¤šæ©Ÿèƒ½ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã™ã€‚web ã‚µãƒ¼ãƒãƒ¼æ©Ÿèƒ½ã¾ã§ã‚‚ã£ã¡ã‚ƒã£ã¦ã¾ã™ã€‚

ä½•åº¦ã‚‚è¨€ã„ã¾ã™ãŒã€è‡ªåˆ†ã¯ã‚ã¾ã‚Šå¥½ã¿ã§ã¯ãªã„ã§ã™ã€‚å¿…è¦æœ€ä½é™ã®æ©Ÿèƒ½ã®ã¿ã‚’æŠ½å‡ºã—ã¦ã€ãã‚ŒãŒã—ã£ã‹ã‚Šå‹•ã‘ã°ãã‚ŒãŒä¸€ç•ªè‰¯ã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚ï¼ˆè¶£å‘³ã‚µãƒ¼ãƒãƒ¼ã¯ãã®ç¯„ç–‡ã§ã¯ãªã„ç¬‘ï¼‰

ã¾ãŸã€è‡ªåˆ†ãŒãŠå®¢æ§˜ã®ã‚µãƒ¼ãƒãƒ¼ã§è¨¼æ˜æ›¸ã‚’è¨­å®šã™ã‚‹ã¨ãã«ã€Let's Encrypt ã§è¨¼æ˜æ›¸ã‚’å–ã‚‹ã¨ãã¯ä¸€æ™‚çš„ã«é€šä¿¡ãŒ http ã«ãªã£ãŸã‚Šã—ã¾ã™ã€‚è‡ªåˆ†ã¯ã€è¨¼æ˜æ›¸ã®å·®ã—æ›¿ãˆã¯è£ã§ã‚„ã£ã¦ã€Nginx ãªã©ã¯`reload`ã‚„`restart`ã®ã¿ã‚’è¡Œã†å½¢å¼ã«ã—ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã«ã¯ã€TXT ãƒ¬ã‚³ãƒ¼ãƒ‰ãªã©ã‚’åˆ©ç”¨ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ¤œè¨¼ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
ã“ã“ã‚’ã€CloudflareAPI ã‚’ã†ã¾ãã“ã­ãã‚Šå›ã—ã¦è§£æ±ºã—ãŸã„ã¨ã“ã‚ã§ã™ã€‚

ä»¥ä¸ŠãŒç¾çŠ¶ã¾ã¨ã‚ã€ã¨ãªã‚Šã¾ã™ã€‚

# ä»Šå¾Œã®è¨¼æ˜æ›¸æ›´æ–°

è¦ä»¶ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚è‡ªå®…ç”¨ã®è‡ªå·±æº€æ§‹æˆãªã®ã§ã‹ãªã‚Šç·©ã‚ã§ã™ã€‚

**è¦ä»¶**

- çµå±€è‡ªåˆ†ãŒã—ãŸã„ã®ã¯ã€Cloudflare ç®¡ç†ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã€è‡ªå‹•çš„ã«è¨¼æ˜æ›¸ãŒæ›´æ–°ã•ã‚Œã¦ã»ã—ã„ã€‚
- è‡ªå®… IP ãŒå¤‰ã‚ã£ãŸã‚‰å‹•ä½œã—ãªã„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã—ãŸããªã„ã€‚
- certbot ã¯å°‘ã—å¤šæ©Ÿèƒ½ã™ãã‚‹ã€‚ZeroSSL ã¯è«–å¤–ã€‚
- æ›´æ–°æ™‚ Web ã‚µãƒ¼ãƒãƒ¼ã‚’æ­¢ã‚ãŸããªã„ã€‚

ä»¥ä¸Šã®è¦ä»¶ã‹ã‚‰ã€è‡ªåˆ†ãŒå‡ºã—ãŸç­”ãˆã¯ä»¥ä¸‹ã®äºŒã¤ã®æ§‹æˆã§ã™ã€‚

**dehydrated**

[github](https://github.com/dehydrated-io/dehydrated) - ã‚·ã‚§ãƒ«ã§æ›¸ã‹ã‚ŒãŸ acme ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (å¿…è¦ãªæ©Ÿèƒ½ã¯å…¨ã¦ã‚ã‚Šã¤ã¤éå¸¸ã«å˜ç´”æ˜å¿«ãªæ§‹é€ ã‚’ã—ã¦ã„ã¾ã™)

**letsencrypt-cloudflare-hook**

[github](https://github.com/kappataumu/letsencrypt-cloudflare-hook) - python è£½ hooks ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (dehydrated ãŒãƒãƒ£ãƒ¬ãƒ³ã‚¸ã® TXT ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ CloudflareAPI çµŒç”±ã§è¨­å®šã§ãã¾ã™ã€‚)

ãƒ¬ã‚´ã§è‡ªåˆ†ãŒæ¬²ã—ã„ã¨ã“ã‚ã ã‘çµ„ã‚“ã ã‚ˆã†ãªæ„Ÿã˜ã§ã™ã­ã€‚è‡ªåˆ†ã¨ã—ã¦ã¯ã“ã‚Œã‚‰ã‚’è¦‹ã¤ã‘ãŸã¨ãçµæ§‹æœ¬æ°—ã§é‹å‘½æ„Ÿã˜ã¾ã—ãŸã€‚

## dehydrated ã¨ã¯

*dehydrated*ã¯ certbot ã¨åŒã˜ã ACME ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«å¯¾å¿œã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã™ã€‚ShellScript ã§æ›¸ã‹ã‚ŒãŸå˜ç´”ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚

certbot ã¨é•ã„ã€è¨¼æ˜æ›¸ã®å–å¾—ã®ã¿ã‚’è¡Œã„ã¾ã™ã€‚è¨¼æ˜æ›¸ã®è¨­å®šãªã©ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã§è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã§ã‚‚ã€ã‚„ã‚‹ã“ã¨ã¯è¨¼æ˜æ›¸ã®æ›´æ–°ãªã®ã§ã€è¨­å®šã¯ã™ã§ã«çµ‚ã‚ã£ã¦ã„ã‚‹ã¯ãšã§ã™ã‚ˆã­ã€‚ãªã®ã§æ­£ç›´è¨¼æ˜æ›¸ã®æ›´æ–°ã”ã¨ãã§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã„ã˜ã‚‹ã ã®ãªã‚“ã ã®ã£ã¦è©±ã‹ã‚‰ãŠã‹ã—ã„ã‚“ã§ã™ã‚ˆã€‚
ã—ã‹ã‚‚ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ¤œè¨¼æ©Ÿèƒ½ã‚‚æœ€ä½é™ã§ã„ã„ã¨æ€ã„ã¾ã™ã€‚è‡ªåˆ†ã® Web ã‚µãƒ¼ãƒãƒ¼ã«ã™ã§ã«ã‚ã‚‹è¨¼æ˜æ›¸ã®æ›´æ–°ã§ã€ãƒªã‚¸ã‚§ã‚¯ãƒˆã•ã‚Œã‚‹ã®ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè‡ªåˆ†ã®æ‰‹ã‹ã‚‰é›¢ã‚ŒãŸå¾Œã‹ã€DNS ã®è¨­å®šã‚’ãƒŸã‚¹ã£ã¦ã„ã‚‹æ™‚ã ã‘ã§ã™ã‚ˆã­ã€‚
ã•ã‚‰ã«ã€certbot ã ã¨ã€nginx ã‚„ apache ã¿ãŸã„ãªä½¿ã„æŠœã‹ã‚Œã¦ã‚‹ã‚µãƒ¼ãƒãƒ¼ãªã‚“ã‹ã ã¨è‡ªå‹•ã§è¨­å®šã‚’ã„ã˜ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¾ã§ã—ã¦ãã‚Œã¾ã™ã‚ˆã­ã€‚

**dehydrated ã«ã¯ãã‚“ãªä½™è¨ˆã™ãã‚‹æ©Ÿèƒ½ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚**

æœ¬å½“ã«ã„ã‚‰ãªã„ã§ã™ã€‚ãã†ã„ã†æ©Ÿèƒ½ã¯ã€

è‡ªåˆ†ãŒæ›´æ–°ã‹ã‘ãªã‘ã‚Œã°ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚ãŒã€è‡ªåˆ†ã¯è¶£å‘³ã‚µãƒ¼ãƒãƒ¼ã§é‡ã„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ›ã‚¹ãƒˆã—ã¦ã‚‹ã‚ã‘ã§ã‚‚ãªã„ã®ã§ã€é »ç¹ã« `refresh-dnf`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯è‡ªä½œã§ã™ç¬‘ã€‚commands ã¨ã„ã†ãƒ¬ãƒã‚¸ãƒˆãƒªã«ã‚ã‚Šã€ä»¥ä¸‹ã®ã‚³ãƒ”ãƒ¼ã‚’è¦‹ã¦ã¿ã¦ãã ã•ã„ã€‚

```bash title="refresh-dnf.sh"
#!/bin/bash

# Refresh DNF
sudo dnf check-update
sudo dnf update -y
sudo dnf upgrade -y
sudo dnf autoremove -y
sudo dnf clean all
sudo dnf makecache
```

æã‚ã—ã„ã¨æ„Ÿã˜ã‚‹äººã‚‚ã„ã‚‹ã§ã—ã‚‡ã†ç¬‘

è‡ªåˆ†ã¯æœ¬å½“ã«ãªã‚“ã¨ãªãã“ã‚Œã§è¡Œã£ã¦ã¾ã™ã€‚å¼·ã„ã¦è¨€ãˆã°ã€æ›´æ–°ã•ã‚Œã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¤šã„ã¨ã‚²ãƒ¼ã‚¸ã®é€²ã‚€ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒé…ãã¦æ¥½ã—ã‚ã‚‹ã£ã¦æ„Ÿã˜ã§ã™ã€‚

ã“ã‚Œã§ã‚‚ã€å®šæœŸçš„ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‹•ãã¹ãã‚‚ã®ã¯ã¡ã‚ƒã‚“ã¨å‹•ã„ã¦æ¬²ã—ã„ã®ãŒç§ã§ã™ã€‚

ã§ã‚ã‚Œã°ã€æ­£ç›´ã‚„ã‚‹ã“ã¨ã¯ãƒã‚¸ã§ã—ã‚‡ã¼ã„å†…å®¹ã§ã™ã€‚ã¨ã„ã†ã‹ã€æ±ºã¾ã‚Šãã£ã¦ã‚‹éç¨‹ã§ã™ã€‚ãã‚Œã‚’ã‚„ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®ä½•ã‚’ä¿å®ˆã™ã‚‹ã‚“ã§ã™ã‹ï¼Ÿ

[certbot](https://github.com/certbot/certbot)ã® commit è¦‹ã¦ã¿ã¦ãã ã•ã„ã€‚ä»Š(2024/03/26)æ™‚ç‚¹ã§è¦‹ã¦ã€ãƒ˜ãƒƒãƒ‰ã®ã‚³ãƒŸãƒƒãƒˆãŒ`5 days ago`ã€ã€ã€ã™ã”ã„ã§ã™ã­ç¬‘

ãƒ³ãƒ³ãƒ³ãƒ³ãƒ³ï½ï½ï½ï½ã€[dehydrated](https://github.com/dehydrated-io/dehydrated/commits/master/)ã¯ã©ã†ã‹ãªï¼Ÿï¼Ÿ ã€ã€`3 month ago`ã€ã€å¾®å¦™ã§ã™ãŒã€ä¸€å¿œ certbot ã‚ˆã‚Šã¯å¤ã„ã§ã™ã€‚ã¨ã„ã†ã‹ã€ã“ã£ã¡ã¯æ§‹é€ ä¸Šè‡ªå‹•çš„ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚Œã¾ã›ã‚“(ä¼ç”»å€’ã‚Œã§ã¯ã‚ã‚‹)ã€‚ã§ã‚‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ 5 å¹´å‰ã‚ˆã‚Šå¤‰ã‚ã£ã¦ãªã„æ§˜ãªã®ã§è¨±ã—ã¦ãã ã•ã„ã€‚

## letsencrypt-cloudflare-hook ã¨ã¯

*letsencrypt-cloudflare-hook*ã¯ã€dehydrated ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³çš„ãªã‚‚ã®ã§ã™ã€‚ãƒ¬ãƒã‚¸ãƒˆãƒªåã« dehydrated ãŒå«ã¾ã‚Œã¦ã„ãªã„ã®ã§åˆ†ã‹ã‚Šã¥ã‚‰ã„ã§ã™ãŒã€‚

dehydrated ã¯ã€hooks ã¨ã„ã†å½¢ã§ API ã®ã‚ˆã†ãªã‚‚ã®ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

ã¾ãšãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ¤œè¨¼æ–¹æ³•ã¨ã—ã¦ã€http ä»¥å¤–ã«ã‚‚ã€TXT æ¤œè¨¼ã‚„ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã® CNAME ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’åˆ©ç”¨ã—ãŸæ¤œè¨¼ãŒã‚ã‚Šã¾ã™ã€‚
ã©ã¡ã‚‰ã‚‚ certbot ã§ã‚‚ ZeroSSL ã§ã‚‚ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã‚Œã«ã¤ã„ã¦ã‚‚ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ä¸­é€”åŠç«¯ã«è‡ªå‹•åŒ–ã—ã¦ã‚‹ã¨ã€ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ†ã‚­ã‚¹ãƒˆãŒå¤‰ã‚ã£ãŸã‚Šã—ãŸã‚‰å¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ãã—ã¦ã€ç§ã¯ CloudflareAPI ã‚’åˆ©ç”¨ã—ã¦ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ DNS ã‚’æ§‹æˆã—ã¦ã„ã¾ã™ã€‚CloudflareAPI ã¯ã‹ãªã‚ŠæŸ”è»Ÿã«ã§ãã¦ãŠã‚Šã€ã“ã‚Œã¨ dehydrated ã® API ã®æ©‹æ¸¡ã—ã‚’ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ(ãƒ—ãƒ©ã‚°ã‚¤ãƒ³)ãŒè¡Œã„ã¾ã™ã€‚

ãã—ã¦ã€TXT æ¤œè¨¼ã§ dehydrated ãŒç‰¹åˆ¥ãªé€šä¿¡ãªã—ã«è¨¼æ˜æ›¸ç™ºè¡Œã¾ã§ã“ãç€ã‘ã¾ã™ã€‚
CloudflareAPI çµŒç”±ãªã®ãŒãªã‚“ã¨ã‚‚ç´ æ™´ã‚‰ã—ã„ã§ã™æœ¬å½“ã«ã€‚

## è¨­å®šå†…å®¹

ã“ã‚Œã‚’è¦‹ã«æ¥ã¦ã„ã‚‹æ–¹ã«ã¯ä½¿ã„æ–¹ãŒã‚ã‹ã£ã¦ã„ã‚‹ãƒ„ãƒ¼ãƒ«ã®èª¬æ˜ãªã©ã„ã‚‰ãªã„ã‹ã¨æ€ã†ã®ã§å‰²æ„›ã—ã¾ã™ã€‚[ã“ã¡ã‚‰](https://github.com/dehydrated-io/dehydrated)ã‚’ã©ã†ãã€‚

ã‚„ã£ãŸã“ã¨ã¯ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. dehydrated ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«(/opt/dehydrated)
2. CloudflareAPI ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
3. letsencrypt-cloudflare-hook ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«(/opt/dehydrated/hooks/cloudflare/hook.py)
4. dehydrated ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®š(/opt/dehydrated/config)
5. å¯¾è±¡ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®š(/opt/dehydrated/domains.txt)

```text title="domains.txt"
code.example.com
ubcode.example.com
example.com
```

# çµæœ

```
[::] buntin@example.com:/opt/dehydrated (master %) $ ./dehydrated -c -t dns-01 -k 'hooks/cloudflare/hook.py'
# INFO: Using main config file /opt/dehydrated/config
 + CloudFlare hook executing: startup_hook
 + Creating chain cache directory /opt/dehydrated/chains
Processing code.example.com
 + Creating new directory /opt/dehydrated/certs/code.example.com ...
 + Signing domains...
 + Generating private key...
 + Generating signing request...
 + Requesting new certificate order from CA...
 + Received 1 authorizations URLs from the CA
 + Handling authorization for code.example.com
 + 1 pending challenge(s)
 + Deploying challenge tokens...
 + CloudFlare hook executing: deploy_challenge
 + Creating TXT record: code.example.com => 8FWozOTG6G7zCTs7zQJWQ34OK3sLFgJUzAGLjbscDPs
 + Challenge: nONCKnH5i7U3CfAQN444-IjR8DhXYPdd1-2vSLH4F7A
 + Unable to locate record named _acme-challenge.code.example.com
 + TXT record created, CFID: 8bba036b11b3533c15ebb2ce30fc8a4f
 + Settling down for 10s...
 + Responding to challenge for code.example.com authorization...
 + Challenge is valid!
 + Cleaning challenge tokens...
 + CloudFlare hook executing: clean_challenge
 + Deleted TXT _acme-challenge.code.example.com, CFID 8bba036b11b3533c15ebb2ce30fc8a4f
 + Requesting certificate...
 + Checking certificate...
 + Done!
 + Creating fullchain.pem...
 + CloudFlare hook executing: deploy_cert
 + ssl_certificate: /opt/dehydrated/certs/code.example.com/fullchain.pem
 + ssl_certificate_key: /opt/dehydrated/certs/code.example.com/privkey.pem
 + Done!
Processing ubcode.example.com
 + Creating new directory /opt/dehydrated/certs/ubcode.example.com ...
 + Signing domains...
 + Generating private key...
 + Generating signing request...
 + Requesting new certificate order from CA...
 + Received 1 authorizations URLs from the CA
 + Handling authorization for ubcode.example.com
 + 1 pending challenge(s)
 + Deploying challenge tokens...
 + CloudFlare hook executing: deploy_challenge
 + Creating TXT record: ubcode.example.com => XuJ-ew6NftVdV1JbQrrBqJ6F-GL9yQf0zNwF0l5jhOg
 + Challenge: GouLgn8g2KM5FPocZcMkMHmXtMOSKsS5d7MVSrx5qT4
 + Unable to locate record named _acme-challenge.ubcode.example.com
 + TXT record created, CFID: efc3b9608a42101d4b31c727a8d62678
 + Settling down for 10s...
 + The DNS response does not contain an answer to the question: _acme-challenge.ubcode.example.com. IN TXT. Retrying query...
 + DNS not propagated, waiting 30s...
 + The DNS response does not contain an answer to the question: _acme-challenge.ubcode.example.com. IN TXT. Retrying query...
 + DNS not propagated, waiting 30s...
 + Responding to challenge for ubcode.example.com authorization...
 + Challenge is valid!
 + Cleaning challenge tokens...
 + CloudFlare hook executing: clean_challenge
 + Deleted TXT _acme-challenge.ubcode.example.com, CFID efc3b9608a42101d4b31c727a8d62678
 + Requesting certificate...
 + Checking certificate...
 + Done!
 + Creating fullchain.pem...
 + CloudFlare hook executing: deploy_cert
 + ssl_certificate: /opt/dehydrated/certs/ubcode.example.com/fullchain.pem
 + ssl_certificate_key: /opt/dehydrated/certs/ubcode.example.com/privkey.pem
 + Done!
Processing example.com
 + Creating new directory /opt/dehydrated/certs/example.com ...
 + Signing domains...
 + Generating private key...
 + Generating signing request...
 + Requesting new certificate order from CA...
 + Received 1 authorizations URLs from the CA
 + Handling authorization for example.com
 + 1 pending challenge(s)
 + Deploying challenge tokens...
 + CloudFlare hook executing: deploy_challenge
 + Creating TXT record: example.com => TB2owBPoTysC6r1c5mUBnxZgKQuu4OmRDklPN9zADyQ
 + Challenge: 2vebQ4X3RyqUzV1qUJXNbZPD15pvyPDpwLIERRa21BQ
 + Unable to locate record named _acme-challenge.example.com
 + TXT record created, CFID: ac73764513bc4e7a4812212c3e8cfc28
 + Settling down for 10s...
 + DNS not propagated, waiting 30s...
 + DNS not propagated, waiting 30s...
 + Responding to challenge for example.com authorization...
 + Challenge is valid!
 + Cleaning challenge tokens...
 + CloudFlare hook executing: clean_challenge
 + Deleted TXT _acme-challenge.example.com, CFID ac73764513bc4e7a4812212c3e8cfc28
 + Requesting certificate...
 + Checking certificate...
 + Done!
 + Creating fullchain.pem...
 + CloudFlare hook executing: deploy_cert
 + ssl_certificate: /opt/dehydrated/certs/example.com/fullchain.pem
 + ssl_certificate_key: /opt/dehydrated/certs/example.com/privkey.pem
 + Done!
 + CloudFlare hook executing: exit_hook
[::] buntin@example.com:/opt/dehydrated (master %) $ ls
```

è¨¼æ˜æ›¸ã®æ›´æ–°ã¯ã“ã‚Œã§çµ‚ã‚ã‚Šã§ã™ã€‚

![welcome-dehydrated/welcome-dehydrated-info](https://res.cloudinary.com/xlog/image/upload/v1/welcome-dehydrated/welcome-dehydrated-info.webp?_a=BAMHUyJu0)

å”¯ã€…ã€ç¥ã€‚ä»¥ä¸Šã§ã™ã€‚(nginx ã¸ã®é©ç”¨ã€ãƒªãƒ­ãƒ¼ãƒ‰ã‚’ãŠå¿˜ã‚Œãªã)

ã“ã‚Œã§ã‚ˆã‚Šå®‰å…¨ã§ç°¡æ½”ãªè¨¼æ˜æ›¸æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ•´ç†ã§ãã¾ã—ãŸã€‚

æ¯å›è¨¼æ˜æ›¸æ›´æ–°ã®ãŸã³ã«æ–°ã—ã„æ–¹æ³•ã«æ‰‹ã‚’å‡ºã—ã¦ãã¾ã—ãŸãŒã€ã—ã°ã‚‰ãã¯å¤‰æ›´ã„ã‚‰ãªã„ãã‚‰ã„å …ç‰¢ãªã®ãŒã§ããŸã¨æ€ã„ã¾ã™ã€‚

ã‚ã¨ã¯ã€ä¾‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚‚ã¨ã«è‡ªåˆ†ãŒæ›¸ã„ãŸ TypeScript è£½ã«ã—ã¡ã‚ƒã„ãŸã„ã§ã™ã­ã€‚Bun & TypeScript æ§‹æˆã«ãƒãƒã£ã¦ã„ã‚‹ã®ã§ãã®ã†ã¡ã‚„ã‚‹ã¨æ€ã„ã¾ã™ã€‚

Cloudflare é–¢é€£ã® Web é€šä¿¡ç³»ã®å¿ƒé…ã¯å…¨ããªã„ã‚“ã§ã™ãŒã€è¨¼æ˜æ›¸é–¢é€£ãŒã©ã†ãªã®ã‹ã€ã€ã€ã¾ã‚æ‰±ã£ã¦ã„ã‚‹ã®ã¯ãƒãƒƒãƒˆã®è¨¼æ˜æ›¸ãªã‚ã‘ã§ã™ã‹ã‚‰å…¨ã¦ã‚ã‚‹ã§ã—ã‚‡ã†ã€‚

ã§ã¯ï¼

# æ”¹è¨‚å±¥æ­´

- 2024/03/08 åˆç¨¿
- 2024/03/26 (è¿½è¨˜) è¨˜äº‹å†…å®¹ãŒã‚¹ã‚«ã‚¹ã‚«ã™ããŸãŸã‚è¿½è¨˜ã€‚ã•ã‚‰ã«è¿½è¨˜å†…å®¹ãŒã‚ã‚‹ãŒæš‡ãªæ™‚é–“å¾…ã¡ã€‚
